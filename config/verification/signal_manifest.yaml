# Signal Service Verification Manifest
#
# Four-layer verification for APEX signal service:
# A. Structural: JSON Schema validation
# B. Semantic: Bounds, identities, no-NaN invariants
# C. Causality: No-lookahead verification (CRITICAL)
# D. Golden Fixtures: Regression snapshots
#
# Usage:
#   python -m src.verification.signal_verifier --all --profile signal_dev
#   python -m src.verification.signal_verifier --phase S1 --profile signal_dev

version: "1.0"
contract_version: "2024.1"
project: "APEX Signal Service"

# ═══════════════════════════════════════════════════════════════
# Layer A: Structural Contracts (JSON Schema)
# ═══════════════════════════════════════════════════════════════
schemas:
  indicator_output: "schemas/indicator_output.schema.json"
  signal_service_payload: "schemas/signal_service_payload.schema.json"

# ═══════════════════════════════════════════════════════════════
# Layer B & C: Semantic Invariants (loaded from external files)
# ═══════════════════════════════════════════════════════════════
invariant_files:
  - "invariants/momentum_bounds.yaml"
  - "invariants/trend_bounds.yaml"
  - "invariants/volatility_bounds.yaml"
  - "invariants/identity.yaml"
  - "invariants/causality.yaml"
  - "invariants/general.yaml"

# ═══════════════════════════════════════════════════════════════
# Layer D: Fixtures Configuration
# ═══════════════════════════════════════════════════════════════
fixtures:
  ohlcv_dir: "tests/fixtures/signal_verification/ohlcv"
  snapshots_dir: "tests/fixtures/signal_verification/snapshots"
  tolerance:
    abs_err: 1e-6
    rel_err: 1e-4
  warmup_slice: true

# ═══════════════════════════════════════════════════════════════
# Verification Phases
# ═══════════════════════════════════════════════════════════════
phases:
  - id: "S1"
    name: "Discovery & Metadata"
    description: "Verify indicator registry and metadata completeness"
    checks:
      - id: "S1_REGISTRY"
        type: "assertion"
        assert: "registry_by_category_min"
        params:
          momentum: 8
          trend: 6
          volatility: 4
          volume: 4
        description: "Minimum indicators per category"

      - id: "S1_METADATA"
        type: "assertion"
        assert: "all_have_metadata"
        fields: ["name", "category", "warmup_periods", "required_fields"]
        description: "All indicators have required metadata fields"

  - id: "S2"
    name: "Engine Determinism & Causality"
    description: "Verify engine produces consistent, causal outputs"
    checks:
      - id: "S2_DETERMINISTIC"
        type: "assertion"
        assert: "engine_deterministic"
        runs: 2
        compare: "byte_equal"
        description: "Same inputs must produce identical outputs"

      - id: "S2_PARALLEL_SAFE"
        type: "assertion"
        assert: "parallel_vs_serial_equal"
        description: "Parallel execution equals serial execution"

      # CRITICAL: No-lookahead verification (all categories)
      - id: "S2_MOMENTUM_CAUSALITY"
        type: "invariant"
        refs: ["MOMENTUM_CAUSALITY"]
        description: "Momentum indicators must not look ahead"

      - id: "S2_TREND_CAUSALITY"
        type: "invariant"
        refs: ["TREND_CAUSALITY"]
        description: "Trend indicators must not look ahead"

      - id: "S2_VOLATILITY_CAUSALITY"
        type: "invariant"
        refs: ["VOLATILITY_CAUSALITY"]
        description: "Volatility indicators must not look ahead"

      - id: "S2_VOLUME_CAUSALITY"
        type: "invariant"
        refs: ["VOLUME_CAUSALITY"]
        description: "Volume indicators must not look ahead"

  - id: "S3"
    name: "Semantic Invariants"
    description: "Verify indicator output contracts"
    checks:
      # Momentum bounds
      - id: "S3_RSI_BOUNDS"
        type: "invariant"
        refs: ["RSI_BOUNDS"]
        description: "RSI in [0, 100]"

      - id: "S3_KDJ_BOUNDS"
        type: "invariant"
        refs: ["KDJ_K_BOUNDS", "KDJ_D_BOUNDS"]
        description: "KDJ K/D in [0, 100]"

      - id: "S3_MFI_BOUNDS"
        type: "invariant"
        refs: ["MFI_BOUNDS"]
        description: "MFI in [0, 100]"

      - id: "S3_WILLIAMS_R_BOUNDS"
        type: "invariant"
        refs: ["WILLIAMS_R_BOUNDS"]
        description: "Williams %R in [-100, 0]"

      - id: "S3_ULTIMATE_BOUNDS"
        type: "invariant"
        refs: ["ULTIMATE_BOUNDS"]
        description: "Ultimate Oscillator in [0, 100]"

      # Trend bounds
      - id: "S3_ADX_BOUNDS"
        type: "invariant"
        refs: ["ADX_BOUNDS", "ADX_DI_PLUS_BOUNDS", "ADX_DI_MINUS_BOUNDS"]
        description: "ADX and DI lines in [0, 100]"

      - id: "S3_AROON_BOUNDS"
        type: "invariant"
        refs: ["AROON_UP_BOUNDS", "AROON_DOWN_BOUNDS"]
        description: "Aroon Up/Down in [0, 100]"

      # Volatility bounds
      - id: "S3_ATR_NONNEG"
        type: "invariant"
        refs: ["ATR_NONNEG"]
        description: "ATR non-negative"

      - id: "S3_STDDEV_NONNEG"
        type: "invariant"
        refs: ["STDDEV_NONNEG"]
        description: "Standard deviation non-negative"

      - id: "S3_HVOL_NONNEG"
        type: "invariant"
        refs: ["HVOL_NONNEG"]
        description: "Historical volatility non-negative"

      # Identity checks
      - id: "S3_MACD_IDENTITY"
        type: "invariant"
        refs: ["MACD_IDENTITY"]
        description: "MACD histogram = 2*(MACD-Signal)"

      - id: "S3_KDJ_J_IDENTITY"
        type: "invariant"
        refs: ["KDJ_J_IDENTITY"]
        description: "KDJ J = 3*K - 2*D"

      - id: "S3_AROON_OSC_IDENTITY"
        type: "invariant"
        refs: ["AROON_OSC_IDENTITY"]
        description: "Aroon Oscillator = Up - Down"

      # General
      - id: "S3_NO_NAN"
        type: "invariant"
        refs: ["NO_NAN_AFTER_WARMUP"]
        description: "No NaN after warmup"

  - id: "S4"
    name: "Golden Fixtures (Regression)"
    description: "Compare against known-good outputs"
    checks:
      - id: "S4_MOMENTUM_SNAP"
        type: "fixture"
        snapshot: "momentum_outputs.jsonl"
        description: "Momentum indicator snapshots"

      - id: "S4_TREND_SNAP"
        type: "fixture"
        snapshot: "trend_outputs.jsonl"
        description: "Trend indicator snapshots"

  - id: "S5"
    name: "Output Contract (Service Payload)"
    description: "Verify service-level output contract"
    checks:
      - id: "S5_INDICATOR_SCHEMA"
        type: "schema"
        target: "indicator_output"
        description: "Indicator output schema validation"

      - id: "S5_PAYLOAD_SCHEMA"
        type: "schema"
        target: "signal_service_payload"
        description: "Service payload schema validation"

      - id: "S5_ROUNDTRIP"
        type: "assertion"
        assert: "payload_roundtrip_equal"
        description: "Payload serialization roundtrip"

      - id: "S5_STABLE_ORDER"
        type: "assertion"
        assert: "output_ordering_stable"
        description: "Output ordering stability"

  - id: "S6"
    name: "Performance (Warning + Degradation Gate)"
    description: "Runtime performance checks"
    checks:
      - id: "S6_PERF"
        type: "performance"
        baseline: "tests/fixtures/signal_verification/baselines/perf_baseline.json"
        thresholds:
          warning_pct: 30
          fail_pct: 100
        description: "+30% = warning, +100% = fail"

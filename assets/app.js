
// Signal Package JavaScript
// Generated by PackageBuilder - supports lazy loading with full chart rendering

const CONFIG = {
    symbols: ["AAPL", "ABBV", "ABT", "ADBE", "AEP", "AMAT", "AMD", "AMGN", "AMT", "AMZN", "APD", "ASML", "AVGO", "AXP", "BA", "BAC", "BLK", "C", "CAT", "CCI", "CHTR", "CL", "CMCSA", "CME", "COP", "COST", "CRM", "CSCO", "CVS", "CVX", "D", "DE", "DHR", "DIA", "DIS", "DLR", "DOW", "DUK", "ECL", "EOG", "EQIX", "EXC", "FCX", "FDX", "GE", "GILD", "GIS", "GLD", "GOOGL", "GS", "HD", "HON", "IBM", "ICE", "INTC", "ISRG", "IWM", "JNJ", "JPM", "KHC", "KLAC", "KMI", "KO", "LIN", "LLY", "LMT", "LOW", "LRCX", "MA", "MCD", "MDT", "META", "MMM", "MO", "MPC", "MRK", "MRVL", "MS", "MSFT", "MU", "NEE", "NEM", "NFLX", "NKE", "NOW", "NUE", "NVDA", "O", "ORCL", "OXY", "PEP", "PFE", "PG", "PLD", "PM", "PSA", "PSX", "QCOM", "QQQ", "RTX", "SBUX", "SCHW", "SHW", "SLB", "SLV", "SMH", "SO", "SPG", "SPGI", "SPY", "SRE", "STZ", "T", "TGT", "TJX", "TLT", "TMO", "TMUS", "TSLA", "TSM", "TXN", "UNH", "UNP", "UPS", "UVXY", "V", "VLO", "VZ", "WELL", "WFC", "WMB", "WMT", "XEL", "XLB", "XLC", "XLE", "XLF", "XLI", "XLK", "XLP", "XLRE", "XLU", "XLV", "XLY", "XOM"],
    timeframes: ["1h", "4h", "1d"],
    dataCache: {},
    summary: null,
    currentSymbol: 'AAPL',
    currentTimeframe: '1d',  // Default to daily timeframe
    signalLookbackBars: 24   // Only show signals from last N bars
};

const colors = {"bg": "#0f172a", "card_bg": "#1e293b", "border": "#334155", "text": "#f8fafc", "text_muted": "#94a3b8", "primary": "#3b82f6", "success": "#22c55e", "warning": "#eab308", "danger": "#ef4444"};

function getDataKey() {
    return `${CONFIG.currentSymbol}_${CONFIG.currentTimeframe}`;
}

// Load summary on page load
async function loadSummary() {
    try {
        const response = await fetch('data/summary.json');
        CONFIG.summary = await response.json();
        console.log('Summary loaded:', CONFIG.summary.symbol_count, 'symbols');
        // Pass current symbol to ensure URL param is respected
        await updateChart(CONFIG.currentSymbol);
    } catch (error) {
        console.error('Failed to load summary:', error);
    }
}

// Lazy load data for a symbol/timeframe
async function loadData(symbol, timeframe) {
    const key = `${symbol}_${timeframe}`;

    // Check cache first
    if (CONFIG.dataCache[key]) {
        return CONFIG.dataCache[key];
    }

    // Show loading state
    const chartEl = document.getElementById('main-chart');
    chartEl.classList.add('loading');
    chartEl.innerHTML = '<div class="loading-spinner">Loading data...</div>';

    try {
        const response = await fetch(`data/${key}.json`);
        if (!response.ok) {
            throw new Error(`Data not found for ${key}`);
        }
        const data = await response.json();
        CONFIG.dataCache[key] = data;
        console.log(`Loaded ${key}: ${data.bar_count} bars`);
        return data;
    } catch (error) {
        console.error(`Failed to load ${key}:`, error);
        chartEl.innerHTML = '<div class="loading-error">Failed to load data for ' + key + '</div>';
        return null;
    }
}

// Update chart with current selection
async function updateChart(symbolOverride = null) {
    // Use override if provided, otherwise read from select (for user interactions)
    const symbol = symbolOverride || document.getElementById('symbol-select').value;
    const timeframe = CONFIG.currentTimeframe;

    CONFIG.currentSymbol = symbol;

    // Sync select element with current symbol
    const selectEl = document.getElementById('symbol-select');
    if (selectEl && selectEl.value !== symbol) {
        selectEl.value = symbol;
    }

    const data = await loadData(symbol, timeframe);
    if (!data) return;

    renderMainChart(data);
    updateSignalHistoryTable();
    updateConfluencePanel();
    updateRegimeSection();
    updateDualMACDHistory(data);
    updateTrendPulseHistory(data);
    updateRegimeFlexHistory(data);
    updateSectorPulseHistory(data);
}

// Render full multi-subplot chart using Plotly (matches SignalReportGenerator)
function renderMainChart(data) {
    const chartEl = document.getElementById('main-chart');
    // Clear loading state
    chartEl.classList.remove('loading');
    chartEl.innerHTML = '';

    const chartData = data.chart_data;
    const traces = [];
    const hasData = (values) => values && values.length > 0 && !values.every(v => v === null);

    // Issue 4: Debug logging for indicator data
    console.log('=== Chart Data Debug ===');
    console.log('Timestamps count:', chartData.timestamps?.length || 0);
    console.log('OHLCV counts:', {
        open: chartData.open?.length || 0,
        high: chartData.high?.length || 0,
        low: chartData.low?.length || 0,
        close: chartData.close?.length || 0,
        volume: chartData.volume?.length || 0
    });
    console.log('Overlay indicators:', Object.keys(chartData.overlays || {}));
    console.log('RSI data keys:', Object.keys(chartData.rsi || {}));
    console.log('MACD data keys:', Object.keys(chartData.macd || {}));
    console.log('RSI values (first 5):', chartData.rsi?.rsi_rsi?.slice(0, 5));
    console.log('MACD values (first 5):', chartData.macd?.macd_macd?.slice(0, 5));
    console.log('Bollinger values (first 5):', chartData.overlays?.bollinger_bb_upper?.slice(0, 5));

    // For intraday charts, use index-based x-axis to avoid gaps
    const isIntraday = ['1m', '5m', '15m', '30m', '1h', '4h'].includes(data.timeframe);
    const xValues = isIntraday
        ? chartData.timestamps.map((_, i) => i)
        : chartData.timestamps;

    // Row 1: Price candlesticks
    traces.push({
        type: 'candlestick',
        x: xValues,
        open: chartData.open,
        high: chartData.high,
        low: chartData.low,
        close: chartData.close,
        name: 'Price',
        increasing: { line: { color: colors.success }, fillcolor: colors.success },
        decreasing: { line: { color: colors.danger }, fillcolor: colors.danger },
        xaxis: 'x',
        yaxis: 'y',
    });

    // Overlay indicators: Bollinger Bands, SuperTrend
    const overlayConfig = {
        'bollinger_bb_upper': { color: '#3b82f6', dash: 'dot' },
        'bollinger_bb_middle': { color: '#6366f1', dash: 'solid' },
        'bollinger_bb_lower': { color: '#3b82f6', dash: 'dot' },
        'supertrend_supertrend': { color: '#f59e0b', dash: 'solid' },
    };
    for (const [name, config] of Object.entries(overlayConfig)) {
        const values = chartData.overlays[name];
        if (!hasData(values)) continue;
        traces.push({
            type: 'scatter',
            mode: 'lines',
            x: xValues,
            y: values,
            name: name.replace('bollinger_bb_', 'BB ').replace('supertrend_', 'ST '),
            line: { color: config.color, width: 1, dash: config.dash },
            xaxis: 'x',
            yaxis: 'y',
        });
    }

    // Row 2: RSI with threshold lines
    const rsiValues = chartData.rsi['rsi_rsi'];
    if (hasData(rsiValues)) {
        traces.push({
            type: 'scatter',
            mode: 'lines',
            x: xValues,
            y: rsiValues,
            name: 'RSI',
            line: { color: '#8b5cf6', width: 1.5 },
            xaxis: 'x',
            yaxis: 'y2',
        });
        const boundsX = [xValues[0], xValues[xValues.length - 1]];
        const rsiLevels = [
            { value: 70, name: 'Overbought', color: colors.danger },
            { value: 30, name: 'Oversold', color: colors.success },
        ];
        for (const level of rsiLevels) {
            traces.push({
                type: 'scatter',
                mode: 'lines',
                x: boundsX,
                y: [level.value, level.value],
                name: level.name,
                line: { color: level.color, width: 1, dash: 'dash' },
                xaxis: 'x',
                yaxis: 'y2',
                showlegend: false,
            });
        }
    }

    // Row 3: MACD subplot (DualMACD if available, else standard MACD)
    const hasDualMACD = chartData.dual_macd && (
        hasData(chartData.dual_macd['dual_macd_slow_histogram']) ||
        hasData(chartData.dual_macd['dual_macd_fast_histogram'])
    );

    if (hasDualMACD) {
        // DualMACD: Overlay slow (55/89) and fast (13/21) histograms
        const slowHist = chartData.dual_macd['dual_macd_slow_histogram'];
        const fastHist = chartData.dual_macd['dual_macd_fast_histogram'];

        // Slow MACD histogram (structural trend) - wider bars, more transparent
        if (hasData(slowHist)) {
            const slowColors = slowHist.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.4)' : 'rgba(239, 68, 68, 0.4)');
            traces.push({
                type: 'bar',
                x: xValues,
                y: slowHist,
                name: 'Slow MACD (55/89)',
                marker: { color: slowColors },
                xaxis: 'x',
                yaxis: 'y3',
                width: isIntraday ? 0.8 : 86400000 * 0.8,
            });
        }

        // Fast MACD histogram (tactical timing) - narrower bars, more opaque
        if (hasData(fastHist)) {
            const fastColors = fastHist.map(v => v >= 0 ? 'rgba(59, 130, 246, 0.8)' : 'rgba(249, 115, 22, 0.8)');
            traces.push({
                type: 'bar',
                x: xValues,
                y: fastHist,
                name: 'Fast MACD (13/21)',
                marker: { color: fastColors },
                xaxis: 'x',
                yaxis: 'y3',
                width: isIntraday ? 0.4 : 86400000 * 0.4,
            });
        }

        // Add zero line for reference
        traces.push({
            type: 'scatter',
            mode: 'lines',
            x: [xValues[0], xValues[xValues.length - 1]],
            y: [0, 0],
            name: 'Zero',
            line: { color: colors.text_muted, width: 1, dash: 'dot' },
            xaxis: 'x',
            yaxis: 'y3',
            showlegend: false,
        });
    } else {
        // Standard MACD fallback
        const macdHist = chartData.macd['macd_histogram'];
        if (hasData(macdHist)) {
            const barColors = macdHist.map(v => v >= 0 ? colors.success : colors.danger);
            traces.push({
                type: 'bar',
                x: xValues,
                y: macdHist,
                name: 'MACD Hist',
                marker: { color: barColors },
                xaxis: 'x',
                yaxis: 'y3',
            });
        }
        const macdLines = [
            { key: 'macd_macd', name: 'MACD', color: '#3b82f6' },
            { key: 'macd_signal', name: 'Signal', color: '#f59e0b' },
        ];
        for (const { key, name, color } of macdLines) {
            const values = chartData.macd[key];
            if (!hasData(values)) continue;
            traces.push({
                type: 'scatter',
                mode: 'lines',
                x: xValues,
                y: values,
                name,
                line: { color, width: 1.5 },
                xaxis: 'x',
                yaxis: 'y3',
            });
        }
    }

    // Row 4: Volume bars
    if (chartData.volume && chartData.volume.length > 0) {
        const volColors = chartData.close.map((c, i) => {
            if (i === 0) return colors.text_muted;
            return c >= chartData.close[i-1] ? colors.success : colors.danger;
        });
        traces.push({
            type: 'bar',
            x: xValues,
            y: chartData.volume,
            name: 'Volume',
            marker: { color: volColors, opacity: 0.5 },
            xaxis: 'x',
            yaxis: 'y4',
        });
    }

    // Add signal markers on price chart
    const key = getDataKey();
    const signals = data.signals || [];
    const buySignals = signals.filter(s => s.direction === 'buy');
    const sellSignals = signals.filter(s => s.direction === 'sell');

    if (buySignals.length > 0) {
        const buyData = buySignals.map(s => {
            const idx = chartData.timestamps.findIndex(t => t === s.timestamp);
            if (idx < 0) return null;
            return {
                x: isIntraday ? idx : s.timestamp,
                y: chartData.low[idx] * 0.995,
                rule: s.rule
            };
        }).filter(d => d !== null);

        if (buyData.length > 0) {
            traces.push({
                type: 'scatter',
                mode: 'markers',
                x: buyData.map(d => d.x),
                y: buyData.map(d => d.y),
                name: 'Buy Signal',
                marker: {
                    symbol: 'triangle-up',
                    size: 12,
                    color: colors.success,
                    line: { color: 'white', width: 1 }
                },
                hovertemplate: '%{text}<extra></extra>',
                text: buyData.map(d => d.rule),
                xaxis: 'x',
                yaxis: 'y',
            });
        }
    }

    if (sellSignals.length > 0) {
        const sellData = sellSignals.map(s => {
            const idx = chartData.timestamps.findIndex(t => t === s.timestamp);
            if (idx < 0) return null;
            return {
                x: isIntraday ? idx : s.timestamp,
                y: chartData.high[idx] * 1.005,
                rule: s.rule
            };
        }).filter(d => d !== null);

        if (sellData.length > 0) {
            traces.push({
                type: 'scatter',
                mode: 'markers',
                x: sellData.map(d => d.x),
                y: sellData.map(d => d.y),
                name: 'Sell Signal',
                marker: {
                    symbol: 'triangle-down',
                    size: 12,
                    color: colors.danger,
                    line: { color: 'white', width: 1 }
                },
                hovertemplate: '%{text}<extra></extra>',
                text: sellData.map(d => d.rule),
                xaxis: 'x',
                yaxis: 'y',
            });
        }
    }

    // Layout with 4 subplots
    const isDaily = ['1d', '1w', '1D', '1W'].includes(data.timeframe);
    let rangebreaks = [];
    if (isDaily) {
        rangebreaks = [{ bounds: ['sat', 'mon'] }];
    }

    // Custom tick labels for intraday
    let tickvals = null;
    let ticktext = null;
    if (isIntraday && chartData.timestamps.length > 0) {
        const n = chartData.timestamps.length;
        const step = Math.max(1, Math.floor(n / 15));
        tickvals = [];
        ticktext = [];
        for (let i = 0; i < n; i += step) {
            tickvals.push(i);
            const ts = new Date(chartData.timestamps[i]);
            const month = String(ts.getUTCMonth() + 1).padStart(2, '0');
            const day = String(ts.getUTCDate()).padStart(2, '0');
            const hour = String(ts.getUTCHours()).padStart(2, '0');
            const min = String(ts.getUTCMinutes()).padStart(2, '0');
            ticktext.push(`${month}/${day} ${hour}:${min}`);
        }
    }

    const layout = {
        title: {
            text: `${data.symbol} - ${data.timeframe} (${data.bar_count} bars)`,
            font: { color: colors.text, size: 18 },
        },
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.08,
            font: { color: colors.text, size: 10 },
        },
        paper_bgcolor: colors.card_bg,
        plot_bgcolor: colors.card_bg,
        font: { color: colors.text },
        margin: { t: 50, r: 50, b: 80, l: 50 },
        hovermode: 'x unified',
        bargap: 0.1,
        barmode: 'overlay',  // DualMACD: overlay long and short histograms

        xaxis: {
            title: { text: 'Time (UTC)', standoff: 10, font: { size: 11, color: colors.text_muted } },
            gridcolor: colors.border,
            showgrid: true,
            rangeslider: { visible: false },
            tickangle: -45,
            domain: [0, 1],
            rangebreaks: rangebreaks,
            ...(isIntraday && tickvals ? { tickvals: tickvals, ticktext: ticktext } : { nticks: 15 }),
        },

        // Y1: Price (48% with gap) - CRITICAL: autorange: true
        yaxis: {
            title: 'Price',
            side: 'right',
            gridcolor: colors.border,
            showgrid: true,
            domain: [0.52, 1.00],
            autorange: true,
        },

        // Y2: RSI (12% with gap)
        yaxis2: {
            title: 'RSI',
            side: 'right',
            gridcolor: colors.border,
            showgrid: true,
            domain: [0.36, 0.48],
            range: [0, 100],
            dtick: 25,
        },

        // Y3: MACD (12% with gap)
        yaxis3: {
            title: hasDualMACD ? 'DualMACD (55/89 + 13/21)' : 'MACD',
            side: 'right',
            gridcolor: colors.border,
            showgrid: true,
            domain: [0.20, 0.32],
        },

        // Y4: Volume (16%)
        yaxis4: {
            title: 'Vol',
            side: 'right',
            gridcolor: colors.border,
            showgrid: true,
            domain: [0.00, 0.16],
        },
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
    };

    Plotly.newPlot('main-chart', traces, layout, config);
}

// Update signal history table - simplified to show only full history
// Active signals and price levels now shown in Confluence Analysis
function updateSignalHistoryTable() {
    const key = getDataKey();
    const cachedData = CONFIG.dataCache[key];
    const container = document.getElementById('signals-content');
    if (!container) return;

    const allSignals = cachedData ? cachedData.signals || [] : [];

    if (allSignals.length === 0) {
        container.innerHTML = '<div class="no-signals">No signals for this symbol/timeframe</div>';
        return;
    }

    // ========== Full Signal History (Collapsible) ==========
    const sortedAll = [...allSignals].sort((a, b) =>
        new Date(b.timestamp) - new Date(a.timestamp)
    );

    let html = `
            <div style="margin-top: 24px;">
                <h4 class="collapsible-header" onclick="toggleHistoryTable()" style="cursor: pointer; margin-bottom: 12px; color: ${colors.text_muted}; font-size: 12px; text-transform: uppercase;">
                    <span id="history-toggle-icon">▶</span> Full Signal History (${allSignals.length} signals) - Click to expand
                </h4>
                <div id="full-history-table" style="display: none;">
                    <table class="signal-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Signal</th>
                                <th>Direction</th>
                                <th>Indicator</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        for (const sig of sortedAll.slice(0, 100)) {
            const time = new Date(sig.timestamp).toLocaleString();
            const direction = sig.direction || 'alert';
            html += `
                <tr>
                    <td>${time}</td>
                    <td>${sig.rule}</td>
                    <td><span class="signal-badge ${direction}">${direction}</span></td>
                    <td>${sig.indicator}</td>
                    <td>${sig.message || '-'}</td>
                </tr>
            `;
        }
        if (allSignals.length > 100) {
            html += `<tr><td colspan="5" style="text-align: center; color: ${colors.text_muted};">... and ${allSignals.length - 100} more signals</td></tr>`;
        }

    html += '</tbody></table></div></div>';

    container.innerHTML = html;
}

// Toggle full history table visibility
function toggleHistoryTable() {
    const table = document.getElementById('full-history-table');
    const icon = document.getElementById('history-toggle-icon');
    if (table && icon) {
        if (table.style.display === 'none') {
            table.style.display = 'block';
            icon.textContent = '▼';
        } else {
            table.style.display = 'none';
            icon.textContent = '▶';
        }
    }
}

// Update confluence panel - enhanced with active signals and price levels
function updateConfluencePanel() {
    const key = getDataKey();
    const container = document.getElementById('confluence-content');
    if (!container || !CONFIG.summary) return;

    const confluence = CONFIG.summary.confluence ? CONFIG.summary.confluence[key] : null;

    // Get active signals and price levels data (moved from Signal History)
    const cachedData = CONFIG.dataCache[key];
    const allSignals = cachedData ? cachedData.signals || [] : [];
    const chartData = cachedData ? cachedData.chart_data || {} : {};
    const priceLevels = chartData.price_levels || {};
    const lastClose = chartData.close && chartData.close.length > 0
        ? chartData.close[chartData.close.length - 1]
        : null;

    if (!confluence) {
        container.innerHTML = '<div class="no-confluence">No confluence data available for this symbol/timeframe</div>';
        return;
    }

    const alignmentPct = (confluence.alignment_score + 100) / 2;
    const alignmentClass = confluence.alignment_score > 20 ? 'bullish' : confluence.alignment_score < -20 ? 'bearish' : 'neutral';

    // ========== Build Active Signals HTML ==========
    let activeSignalsHtml = '';
    if (allSignals.length > 0) {
        const activeByIndicator = {};
        const sortedByTime = [...allSignals].sort((a, b) =>
            new Date(a.timestamp) - new Date(b.timestamp)
        );
        for (const sig of sortedByTime) {
            activeByIndicator[sig.indicator || 'unknown'] = sig;
        }
        const signals = Object.values(activeByIndicator);
        const buyCount = signals.filter(s => s.direction === 'buy').length;
        const sellCount = signals.filter(s => s.direction === 'sell').length;
        const neutralCount = signals.length - buyCount - sellCount;

        const sortedActiveSignals = [...signals].sort((a, b) =>
            (a.indicator || '').localeCompare(b.indicator || '')
        );

        let signalBarsHtml = sortedActiveSignals.slice(0, 8).map(sig => {
            const direction = sig.direction || 'alert';
            const barColor = direction === 'buy' ? colors.success : direction === 'sell' ? colors.danger : colors.text_muted;
            return `
                <div style="display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px;">
                    <span style="color: ${colors.text_muted};">${sig.indicator}</span>
                    <span style="color: ${barColor};">${sig.rule}</span>
                </div>
            `;
        }).join('');

        if (signals.length > 8) {
            signalBarsHtml += `<div style="color: ${colors.text_muted}; font-size: 10px; text-align: center; margin-top: 4px;">+${signals.length - 8} more</div>`;
        }

        activeSignalsHtml = `
            <div style="background: ${colors.card_bg}; padding: 12px; border-radius: 8px; border: 1px solid ${colors.border};">
                <h4 style="margin: 0 0 8px 0; color: ${colors.text}; font-size: 12px; font-weight: 600;">
                    Active Signals - ${CONFIG.currentTimeframe.toUpperCase()}
                </h4>
                <div style="display: flex; gap: 12px; margin-bottom: 8px; font-size: 12px;">
                    <span style="color: ${colors.success};">▲ ${buyCount} Bullish</span>
                    <span style="color: ${colors.danger};">▼ ${sellCount} Bearish</span>
                    <span style="color: ${colors.text_muted};">● ${neutralCount} Neutral</span>
                </div>
                <div class="signal-bars">
                    ${signalBarsHtml}
                </div>
            </div>
        `;
    }

    // ========== Build Price Levels HTML ==========
    let priceLevelsHtml = '';
    const hasLevels = Object.keys(priceLevels).length > 0;
    if (hasLevels && lastClose) {
        const levelGroups = {};
        for (const [col, values] of Object.entries(priceLevels)) {
            if (!values || values.length === 0) continue;
            const lastVal = values[values.length - 1];
            if (lastVal === null || lastVal === undefined) continue;

            const parts = col.split('_');
            const ind = parts[0].toUpperCase();
            const level = parts.slice(1).join('_').toUpperCase();

            if (!levelGroups[ind]) levelGroups[ind] = [];
            levelGroups[ind].push({ level, value: lastVal });
        }

        let levelCardsHtml = '';
        for (const [ind, levels] of Object.entries(levelGroups)) {
            levels.sort((a, b) => b.value - a.value);

            let indName = ind;
            if (ind === 'FIB') indName = 'Fibonacci';
            else if (ind === 'SR') indName = 'Support/Res';
            else if (ind === 'PIVOT') indName = 'Pivot Points';

            let levelRowsHtml = levels.slice(0, 3).map(({ level, value }) => {
                const diff = ((value - lastClose) / lastClose * 100).toFixed(2);
                const isAbove = value > lastClose;
                const levelColor = isAbove ? colors.danger : colors.success;
                const arrow = isAbove ? '↑' : '↓';
                return `
                    <div style="display: flex; justify-content: space-between; font-size: 11px; padding: 2px 0;">
                        <span style="color: ${colors.text_muted};">${level.replace(/_/g, ' ')}</span>
                        <span>$${value.toFixed(2)} <span style="color: ${levelColor};">${arrow}${Math.abs(diff)}%</span></span>
                    </div>
                `;
            }).join('');

            levelCardsHtml += `
                <div style="background: ${colors.card_bg}; padding: 10px; border-radius: 6px; border: 1px solid ${colors.border}; min-width: 140px;">
                    <div style="font-weight: 600; margin-bottom: 6px; font-size: 11px; color: ${colors.text};">${indName}</div>
                    ${levelRowsHtml}
                </div>
            `;
        }

        priceLevelsHtml = `
            <div style="margin-top: 16px;">
                <h4 style="margin: 0 0 10px 0; color: ${colors.text_muted}; font-size: 11px; text-transform: uppercase;">
                    Key Price Levels ($${lastClose.toFixed(2)})
                </h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    ${levelCardsHtml}
                </div>
            </div>
        `;
    }

    // ========== Build Divergence HTML ==========
    let divergenceHtml = '';
    if (confluence.diverging_pairs && confluence.diverging_pairs.length > 0) {
        divergenceHtml = confluence.diverging_pairs.slice(0, 5).map(p => `
            <div class="divergence-item">
                <div class="indicators">${p.ind1} - ${p.ind2}</div>
                <div class="reason">${p.reason}</div>
            </div>
        `).join('');
    } else {
        divergenceHtml = '<div class="no-divergences">No divergences detected - indicators are aligned</div>';
    }

    // ========== Render Enhanced 2-Column Layout ==========
    container.innerHTML = `
        <div class="confluence-panel-enhanced">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px;">
                <div class="alignment-column">
                    <div class="alignment-meter">
                        <div class="alignment-bar">
                            <div class="alignment-indicator" style="left: ${alignmentPct}%"></div>
                        </div>
                    </div>
                    <div class="alignment-value ${alignmentClass}" style="text-align: center; font-size: 24px; font-weight: bold; margin: 8px 0;">
                        ${confluence.alignment_score > 0 ? '+' : ''}${Math.round(confluence.alignment_score)}
                    </div>
                    <div class="signal-counts" style="display: flex; justify-content: center; gap: 16px;">
                        <div style="text-align: center;">
                            <div class="count-value bullish" style="font-size: 16px;">&#9650; ${confluence.bullish_count}</div>
                            <div style="font-size: 10px; color: ${colors.text_muted};">Bullish</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="count-value neutral" style="font-size: 16px;">&#9679; ${confluence.neutral_count}</div>
                            <div style="font-size: 10px; color: ${colors.text_muted};">Neutral</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="count-value bearish" style="font-size: 16px;">&#9660; ${confluence.bearish_count}</div>
                            <div style="font-size: 10px; color: ${colors.text_muted};">Bearish</div>
                        </div>
                    </div>
                </div>
                <div class="active-signals-column">
                    ${activeSignalsHtml}
                </div>
            </div>
            ${priceLevelsHtml}
            <div style="margin-top: 16px;">
                <h4 style="margin: 0 0 12px 0; color: ${colors.text_muted}; font-size: 11px; text-transform: uppercase;">Diverging Indicators</h4>
                ${divergenceHtml}
            </div>
        </div>
    `;
}

// Regime HTML cache
const regimeHtmlCache = {};

// Update regime section - Load pre-rendered HTML for 1:1 feature parity
async function updateRegimeSection() {
    const container = document.getElementById('regime-content');
    if (!container) return;

    const symbol = CONFIG.currentSymbol;
    const timeframe = CONFIG.currentTimeframe;
    const cacheKey = `${symbol}_${timeframe}`;

    // Check cache first
    if (regimeHtmlCache[cacheKey]) {
        container.innerHTML = regimeHtmlCache[cacheKey];
        return;
    }

    // Show loading state
    container.innerHTML = '<div class="no-regime">Loading regime analysis...</div>';

    // Try timeframe-specific file first, then fall back to symbol-only
    const urls = [
        `data/regime/${symbol}_${timeframe}.html`,
        `data/regime/${symbol}.html`
    ];

    for (const url of urls) {
        try {
            const response = await fetch(url);
            if (response.ok) {
                const html = await response.text();
                regimeHtmlCache[cacheKey] = html;
                container.innerHTML = html;
                console.log(`Loaded regime HTML from ${url}`);
                return;
            }
        } catch (error) {
            console.debug(`Failed to load ${url}:`, error);
        }
    }

    // Fall back to summary data if no pre-rendered HTML
    console.warn(`No regime HTML found for ${cacheKey}, using fallback`);
    fallbackRegimeSection(container, symbol);
}

// Fallback: render basic regime info from summary data
function fallbackRegimeSection(container, symbol) {
    if (!CONFIG.summary) {
        container.innerHTML = '<div class="no-regime">No regime data available for ' + symbol + '</div>';
        return;
    }

    const tickers = CONFIG.summary.tickers || [];
    const ticker = tickers.find(t => t.symbol === symbol);

    if (!ticker || !ticker.regime) {
        container.innerHTML = '<div class="no-regime">No regime data available for ' + symbol + '</div>';
        return;
    }

    const regimeColors = {
        'R0': colors.success,
        'R1': colors.warning,
        'R2': colors.danger,
        'R3': colors.primary,
    };
    const regimeNames = {
        'R0': 'Healthy Uptrend',
        'R1': 'Choppy/Extended',
        'R2': 'Risk-Off',
        'R3': 'Rebound Window',
    };
    const regimeColor = regimeColors[ticker.regime] || colors.text_muted;

    const components = ticker.component_states || {};
    const cv = ticker.component_values || {};
    const transition = ticker.transition || {};
    const quality = ticker.quality || {};

    const stateColors = {
        'trend_up': colors.success, 'trend_down': colors.danger, 'neutral': colors.text_muted,
        'vol_high': colors.danger, 'vol_normal': colors.text_muted, 'vol_low': colors.success,
        'choppy': colors.warning, 'trending': colors.success,
        'overbought': colors.danger, 'oversold': colors.success, 'slightly_high': colors.warning, 'slightly_low': colors.primary,
    };

    const formatState = (state) => {
        const color = stateColors[state] || colors.text_muted;
        return `<span style="color: ${color}; font-weight: 500;">${state ? state.toUpperCase().replace('_', ' ') : 'N/A'}</span>`;
    };

    container.innerHTML = `
        <div class="regime-dashboard">
            <div class="regime-header">
                <div class="regime-badge" style="background: ${regimeColor}20; color: ${regimeColor}; border: 2px solid ${regimeColor}; padding: 12px 24px; border-radius: 12px; font-size: 24px; font-weight: 700;">
                    ${ticker.regime}
                </div>
                <div style="flex: 1;">
                    <div class="regime-name" style="font-size: 18px; font-weight: 600;">${ticker.regime_name || regimeNames[ticker.regime] || 'Unknown'}</div>
                    <div class="regime-confidence" style="color: ${colors.text_muted};">Confidence: ${ticker.confidence || 0}%</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                <div class="regime-components" style="background: ${colors.bg}; border-radius: 8px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: ${colors.text_muted}; font-size: 12px; text-transform: uppercase;">Component States</h4>
                    <div class="component-row" style="display: flex; justify-content: space-between; padding: 6px 0;">
                        <span class="component-label">Trend:</span>
                        ${formatState(components.trend_state)}
                    </div>
                    <div class="component-row" style="display: flex; justify-content: space-between; padding: 6px 0;">
                        <span class="component-label">Volatility:</span>
                        ${formatState(components.vol_state)}
                    </div>
                    <div class="component-row" style="display: flex; justify-content: space-between; padding: 6px 0;">
                        <span class="component-label">Choppiness:</span>
                        ${formatState(components.chop_state)}
                    </div>
                    <div class="component-row" style="display: flex; justify-content: space-between; padding: 6px 0;">
                        <span class="component-label">Extension:</span>
                        ${formatState(components.ext_state)}
                    </div>
                </div>
                <div class="regime-metrics" style="background: ${colors.bg}; border-radius: 8px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: ${colors.text_muted}; font-size: 12px; text-transform: uppercase;">Key Metrics</h4>
                    <div class="metric-row" style="display: flex; justify-content: space-between; padding: 6px 0;">
                        <span class="metric-label">Close:</span>
                        <span class="metric-value" style="font-weight: 500;">${cv.close ? '$' + cv.close.toFixed(2) : 'N/A'}</span>
                    </div>
                    <div class="metric-row" style="display: flex; justify-content: space-between; padding: 6px 0;">
                        <span class="metric-label">MA50:</span>
                        <span class="metric-value">${cv.ma50 ? '$' + cv.ma50.toFixed(2) : 'N/A'}</span>
                    </div>
                </div>
            </div>
            <p style="margin-top: 16px; color: ${colors.text_muted}; font-size: 12px;">
                <em>Note: Full regime analysis not available. Showing summary data.</em>
            </p>
        </div>
    `;
}

// Update DualMACD Historical State — current summary card + collapsible history table
function updateDualMACDHistory(data) {
    const container = document.getElementById('dual-macd-history-table');
    if (!container) return;

    const rows = data.dual_macd_history || [];
    if (rows.length === 0) {
        container.innerHTML = '<div style="color: ' + colors.text_muted + '; padding: 16px;">No DualMACD history available for this symbol/timeframe.</div>';
        return;
    }

    const border = colors.border || '#334155';
    const muted = colors.text_muted || '#94a3b8';
    const headerBg = colors.bg || '#1e293b';
    const cardBg = colors.card_bg || '#1e293b';

    const trendColors = {
        'BULLISH': '#10b981',
        'BEARISH': '#ef4444',
        'DETERIORATING': '#f59e0b',
        'IMPROVING': '#06b6d4',
    };

    const trendIcons = {
        'BULLISH': '\u25b2',
        'BEARISH': '\u25bc',
        'DETERIORATING': '\u25b6',
        'IMPROVING': '\u25c0',
    };

    const rowColors = {
        'DIP_BUY': 'rgba(16, 185, 129, 0.10)',
        'RALLY_SELL': 'rgba(239, 68, 68, 0.10)',
        'NONE': 'transparent',
    };

    // ========== Current State Summary Card (always visible) ==========
    const cur = rows[0]; // newest bar (rows are newest-first)
    const curTrend = cur.trend_state || 'BEARISH';
    const curTactical = cur.tactical_signal || 'NONE';
    const curBalance = cur.momentum_balance || 'BALANCED';
    const curConf = Math.round((cur.confidence || 0) * 100);
    const curTrendColor = trendColors[curTrend] || muted;
    const curTrendIcon = trendIcons[curTrend] || '';
    const curConfColor = curConf >= 50 ? '#10b981' : curConf >= 25 ? '#f59e0b' : muted;

    let tacticalBadge;
    if (curTactical === 'DIP_BUY') {
        tacticalBadge = `<span style="background:rgba(16,185,129,0.15);color:#10b981;border:1px solid #10b981;padding:4px 12px;border-radius:6px;font-weight:700;font-size:14px;">DIP BUY</span>`;
    } else if (curTactical === 'RALLY_SELL') {
        tacticalBadge = `<span style="background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid #ef4444;padding:4px 12px;border-radius:6px;font-weight:700;font-size:14px;">RALLY SELL</span>`;
    } else {
        tacticalBadge = `<span style="background:rgba(148,163,184,0.1);color:${muted};border:1px solid ${border};padding:4px 12px;border-radius:6px;font-size:14px;">No Signal</span>`;
    }

    const summaryCard = `
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;margin-bottom:20px;">
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Trend State</div>
                <div style="font-size:18px;font-weight:700;color:${curTrendColor};">
                    ${curTrendIcon} ${curTrend}
                </div>
                <div style="font-size:11px;color:${muted};margin-top:4px;">
                    H_slow ${cur.slow_histogram >= 0 ? '+' : ''}${cur.slow_histogram.toFixed(2)}
                    &middot; \u0394 ${cur.slow_hist_delta >= 0 ? '+' : ''}${cur.slow_hist_delta.toFixed(3)}
                </div>
            </div>
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Tactical Signal</div>
                <div style="margin-top:4px;">
                    ${tacticalBadge}
                </div>
                <div style="font-size:11px;color:${muted};margin-top:8px;">
                    H_fast ${cur.fast_histogram >= 0 ? '+' : ''}${cur.fast_histogram.toFixed(2)}
                    &middot; \u0394 ${cur.fast_hist_delta >= 0 ? '+' : ''}${cur.fast_hist_delta.toFixed(3)}
                </div>
            </div>
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Momentum Balance</div>
                <div style="font-size:16px;font-weight:600;color:${colors.text};margin-top:4px;">
                    ${curBalance.replace('_', ' ')}
                </div>
                <div style="font-size:11px;color:${muted};margin-top:4px;">
                    Slow norm ${(cur.slow_histogram >= 0 ? Math.abs(cur.slow_histogram) : Math.abs(cur.slow_histogram)).toFixed(2)}
                </div>
            </div>
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Confidence</div>
                <div style="font-size:24px;font-weight:700;color:${curConfColor};">
                    ${curConf}%
                </div>
                <div style="width:80%;height:6px;background:${border};border-radius:3px;overflow:hidden;margin:6px auto 0;">
                    <div style="width:${curConf}%;height:100%;background:${curConfColor};border-radius:3px;"></div>
                </div>
            </div>
        </div>
        <div style="font-size:11px;color:${muted};margin-bottom:4px;">
            As of ${cur.date} · ${data.symbol} · ${data.timeframe}
        </div>
    `;

    // ========== History Table (collapsible) ==========
    let bodyHtml = '';
    for (const row of rows) {
        const tactical = row.tactical_signal || 'NONE';
        const trend = row.trend_state || 'BEARISH';
        const rowBg = rowColors[tactical] || 'transparent';
        const trendColor = trendColors[trend] || muted;
        const conf = Math.round((row.confidence || 0) * 100);
        const confColor = conf >= 50 ? '#10b981' : conf >= 25 ? '#f59e0b' : muted;

        let tacticalCell;
        if (tactical === 'DIP_BUY') {
            tacticalCell = '<span style="color: #10b981; font-weight: 600;">DIP_BUY</span>';
        } else if (tactical === 'RALLY_SELL') {
            tacticalCell = '<span style="color: #ef4444; font-weight: 600;">RALLY_SELL</span>';
        } else {
            tacticalCell = '<span style="color: ' + muted + ';">\u2014</span>';
        }

        const confBar = `<div style="display:flex;align-items:center;gap:4px;">` +
            `<div style="width:40px;height:6px;background:${border};border-radius:3px;overflow:hidden;">` +
            `<div style="width:${conf}%;height:100%;background:${confColor};"></div>` +
            `</div><span style="font-size:10px;">${conf}</span></div>`;

        bodyHtml += `<tr style="background:${rowBg};border-bottom:1px solid ${border};">
            <td style="padding:4px 8px;font-size:11px;white-space:nowrap;">${row.date}</td>
            <td style="padding:4px 6px;text-align:right;font-family:monospace;font-size:11px;">${(row.slow_histogram >= 0 ? '+' : '') + row.slow_histogram.toFixed(3)}</td>
            <td style="padding:4px 6px;text-align:right;font-family:monospace;font-size:11px;">${(row.fast_histogram >= 0 ? '+' : '') + row.fast_histogram.toFixed(3)}</td>
            <td style="padding:4px 6px;text-align:right;font-family:monospace;font-size:11px;">${(row.slow_hist_delta >= 0 ? '+' : '') + row.slow_hist_delta.toFixed(3)}</td>
            <td style="padding:4px 6px;text-align:right;font-family:monospace;font-size:11px;">${(row.fast_hist_delta >= 0 ? '+' : '') + row.fast_hist_delta.toFixed(3)}</td>
            <td style="padding:4px 6px;color:${trendColor};font-weight:500;font-size:11px;">${trend}</td>
            <td style="padding:4px 6px;font-size:11px;">${tacticalCell}</td>
            <td style="padding:4px 6px;font-size:11px;color:${muted};">${row.momentum_balance || '\u2014'}</td>
            <td style="padding:4px 6px;font-size:11px;">${confBar}</td>
        </tr>`;
    }

    const historyTable = `
        <div style="margin-top:16px;">
            <h4 style="cursor:pointer;margin:0 0 8px 0;color:${muted};font-size:12px;text-transform:uppercase;"
                onclick="(function(el){
                    const t=el.nextElementSibling;
                    const show=t.style.display==='none';
                    t.style.display=show?'block':'none';
                    el.querySelector('span').textContent=show?'\u25bc':'\u25b6';
                })(this)">
                <span>\u25b6</span> Bar-by-Bar History (${rows.length} bars) — Click to expand
            </h4>
            <div style="display:none;">
                <div style="font-size:11px;color:${muted};margin-bottom:8px;">
                    Newest first · ET ·
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(16,185,129,0.10);border:1px solid #10b981;border-radius:2px;vertical-align:middle;"></span> DIP_BUY
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(239,68,68,0.10);border:1px solid #ef4444;border-radius:2px;vertical-align:middle;margin-left:8px;"></span> RALLY_SELL
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;color:${colors.text};font-size:12px;">
                        <thead>
                            <tr style="background:${headerBg};border-bottom:2px solid ${border};">
                                <th style="padding:6px 8px;text-align:left;font-size:11px;color:${muted};">Date</th>
                                <th style="padding:6px 6px;text-align:right;font-size:11px;color:${muted};">H_slow</th>
                                <th style="padding:6px 6px;text-align:right;font-size:11px;color:${muted};">H_fast</th>
                                <th style="padding:6px 6px;text-align:right;font-size:11px;color:${muted};">\u0394H_slow</th>
                                <th style="padding:6px 6px;text-align:right;font-size:11px;color:${muted};">\u0394H_fast</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};">Trend</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};">Tactical</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};">Mom.Bal</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};">Conf</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = `<div style="padding:16px;">${summaryCard}${historyTable}</div>`;
}

// Update TrendPulse Historical State — summary card + collapsible history table
function updateTrendPulseHistory(data) {
    const container = document.getElementById('trend-pulse-history-table');
    if (!container) return;

    const rows = data.trend_pulse_history || [];
    if (rows.length === 0) {
        container.innerHTML = '<div style="color: ' + colors.text_muted + '; padding: 16px;">No TrendPulse history available for this symbol/timeframe.</div>';
        return;
    }

    const border = colors.border || '#334155';
    const muted = colors.text_muted || '#94a3b8';
    const headerBg = colors.bg || '#1e293b';
    const cardBg = colors.card_bg || '#1e293b';

    const signalColors = { 'BUY': '#10b981', 'SELL': '#ef4444', 'NONE': muted };
    const trendColors = { 'BULLISH': '#10b981', 'BEARISH': '#ef4444', 'NEUTRAL': muted };
    const topColors = { 'TOP_DETECTED': '#a855f7', 'TOP_ZONE': '#f59e0b', 'TOP_PENDING': '#facc15', 'NONE': muted };
    const dmStateColors = { 'BULLISH': '#10b981', 'IMPROVING': '#06b6d4', 'DETERIORATING': '#f59e0b', 'BEARISH': '#ef4444' };
    const exitColors = { 'atr_stop': '#ef4444', 'dm_regime': '#f59e0b', 'zig_sell': '#a855f7', 'top_detected': '#ec4899', 'none': muted };
    const rowBgColors = {
        'BUY': 'rgba(16, 185, 129, 0.10)',
        'SELL': 'rgba(239, 68, 68, 0.10)',
        'ENTRY': 'rgba(16, 185, 129, 0.15)',
        'TOP_DETECTED': 'rgba(168, 85, 247, 0.10)',
        'TOP_ZONE': 'rgba(245, 158, 11, 0.10)',
    };

    // ========== Current State Summary Card ==========
    const cur = rows[0];
    const curSwing = cur.swing_signal || 'NONE';
    const curTrend = cur.trend_filter || 'NEUTRAL';
    const curTop = cur.top_warning || 'NONE';
    const curConf4f = Math.round((cur.confidence_4f || 0) * 100);
    const curScore = Math.round(cur.score || 0);
    const curStrength = (cur.trend_strength || 0).toFixed(2);
    const curLabel = cur.trend_strength_label || 'WEAK';
    const curAlign = cur.ema_alignment || 'MIXED';
    const curDmState = cur.dm_state || 'BEARISH';
    const curAdx = Math.round(cur.adx || 0);
    const curAdxOk = cur.adx_ok || false;
    const curEntry = cur.entry_signal || false;
    const curExit = cur.exit_signal || 'none';
    const curAtrStop = cur.atr_stop_level || 0;
    const curCooldown = cur.cooldown_left || 0;

    const curTrendColor = trendColors[curTrend] || muted;
    const curDmColor = dmStateColors[curDmState] || muted;
    const curConfColor = curConf4f >= 50 ? '#10b981' : curConf4f >= 25 ? '#f59e0b' : muted;
    const curScoreColor = curScore >= 80 ? '#10b981' : curScore >= 50 ? '#f59e0b' : muted;

    let swingBadge;
    if (curEntry) {
        swingBadge = `<span style="background:rgba(16,185,129,0.2);color:#10b981;border:1px solid #10b981;padding:4px 12px;border-radius:6px;font-weight:700;font-size:14px;">\u2713 ENTRY</span>`;
    } else if (curSwing === 'BUY') {
        swingBadge = `<span style="background:rgba(16,185,129,0.15);color:#10b981;border:1px solid #10b981;padding:4px 12px;border-radius:6px;font-weight:700;font-size:14px;">BUY</span>`;
    } else if (curSwing === 'SELL') {
        swingBadge = `<span style="background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid #ef4444;padding:4px 12px;border-radius:6px;font-weight:700;font-size:14px;">SELL</span>`;
    } else {
        swingBadge = `<span style="background:rgba(148,163,184,0.1);color:${muted};border:1px solid ${border};padding:4px 12px;border-radius:6px;font-size:14px;">No Signal</span>`;
    }

    let topBadge;
    if (curTop === 'TOP_DETECTED') {
        topBadge = `<span style="color:#a855f7;font-weight:700;">TOP_DETECTED</span>`;
    } else if (curTop === 'TOP_ZONE') {
        topBadge = `<span style="color:#f59e0b;font-weight:700;">TOP_ZONE</span>`;
    } else if (curTop === 'TOP_PENDING') {
        topBadge = `<span style="color:#facc15;">TOP_PENDING</span>`;
    } else {
        topBadge = `<span style="color:${muted};">\u2014</span>`;
    }

    const exitBadge = curExit !== 'none'
        ? `<span style="color:${exitColors[curExit] || muted};font-weight:600;">${curExit}</span>`
        : `<span style="color:${muted};">\u2014</span>`;

    const summaryCard = `
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;margin-bottom:12px;">
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Signal</div>
                <div style="margin-top:4px;">${swingBadge}</div>
                <div style="font-size:11px;color:${muted};margin-top:6px;">EMA: ${curAlign.replace('ALIGNED_', '')}</div>
            </div>
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Trend / DM</div>
                <div style="font-size:18px;font-weight:700;color:${curTrendColor};">
                    ${curTrend === 'BULLISH' ? '\u25b2' : curTrend === 'BEARISH' ? '\u25bc' : '\u25c6'} ${curTrend}
                </div>
                <div style="font-size:11px;color:${curDmColor};margin-top:4px;">MACD: ${curDmState} · ADX ${curAdx}${curAdxOk ? '' : ' \u26a0'}</div>
                <div style="font-size:11px;color:${muted};margin-top:2px;">Strength ${curStrength} (${curLabel})</div>
            </div>
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Risk</div>
                <div style="font-size:16px;margin-top:4px;">${topBadge}</div>
                <div style="font-size:11px;color:${muted};margin-top:6px;">ATR Stop ${curAtrStop > 0 ? '$' + curAtrStop.toFixed(2) : '\u2014'}</div>
                <div style="font-size:11px;margin-top:2px;">Exit: ${exitBadge} · CD: <span style="color:${curCooldown === 0 ? '#10b981' : '#ef4444'};font-weight:600;">${curCooldown}</span></div>
            </div>
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Score / Confidence</div>
                <div style="font-size:24px;font-weight:700;color:${curScoreColor};">
                    ${curScore}
                </div>
                <div style="width:80%;height:6px;background:${border};border-radius:3px;overflow:hidden;margin:6px auto 0;">
                    <div style="width:${curConf4f}%;height:100%;background:${curConfColor};border-radius:3px;"></div>
                </div>
                <div style="font-size:10px;color:${muted};margin-top:4px;">4F Conf ${curConf4f}%</div>
            </div>
        </div>
        <div style="font-size:11px;color:${muted};margin-bottom:4px;">
            As of ${cur.date} · ${data.symbol} · ${data.timeframe}
        </div>
    `;

    // ========== History Table ==========
    let bodyHtml = '';
    for (const row of rows) {
        const swing = row.swing_signal || 'NONE';
        const trend = row.trend_filter || 'NEUTRAL';
        const top = row.top_warning || 'NONE';
        const strength = (row.trend_strength || 0).toFixed(2);
        const entry = row.entry_signal || false;
        const dmState = row.dm_state || 'BEARISH';
        const adxVal = Math.round(row.adx || 0);
        const adxOk = row.adx_ok || false;
        const conf4f = Math.round((row.confidence_4f || 0) * 100);
        const atrStop = row.atr_stop_level || 0;
        const cooldown = row.cooldown_left || 0;
        const exitSig = row.exit_signal || 'none';

        let rowBg = 'transparent';
        if (entry) rowBg = rowBgColors['ENTRY'];
        else if (swing !== 'NONE') rowBg = rowBgColors[swing] || 'transparent';
        else if (top === 'TOP_DETECTED' || top === 'TOP_ZONE') rowBg = rowBgColors[top] || 'transparent';

        const trendColor = trendColors[trend] || muted;
        const dmColor = dmStateColors[dmState] || muted;
        const confColor = conf4f >= 50 ? '#10b981' : conf4f >= 25 ? '#f59e0b' : muted;

        let swingCell;
        if (swing === 'BUY') swingCell = '<span style="color:#10b981;font-weight:600;">BUY</span>';
        else if (swing === 'SELL') swingCell = '<span style="color:#ef4444;font-weight:600;">SELL</span>';
        else swingCell = '<span style="color:' + muted + ';">\u2014</span>';

        const entryCell = entry
            ? '<span style="color:#10b981;font-weight:700;">\u2713</span>'
            : '<span style="color:' + muted + ';">\u2014</span>';

        const dmCell = `<span style="color:${dmColor};font-weight:500;">${dmState}</span>`;

        const adxBg = adxOk ? 'transparent' : 'rgba(239,68,68,0.15)';
        const adxCell = `<span style="background:${adxBg};padding:1px 3px;border-radius:2px;font-family:monospace;">${adxVal}</span>`;

        let topCell;
        if (top !== 'NONE') {
            const tc = topColors[top] || muted;
            topCell = `<span style="color:${tc};font-weight:600;">${top}</span>`;
        } else {
            topCell = '<span style="color:' + muted + ';">\u2014</span>';
        }

        const confBar = `<div style="display:flex;align-items:center;gap:4px;">` +
            `<div style="width:40px;height:6px;background:${border};border-radius:3px;overflow:hidden;">` +
            `<div style="width:${conf4f}%;height:100%;background:${confColor};"></div>` +
            `</div><span style="font-size:10px;">${conf4f}</span></div>`;

        const atrCell = atrStop > 0
            ? `<span style="font-family:monospace;">$${atrStop.toFixed(2)}</span>`
            : '<span style="color:' + muted + ';">\u2014</span>';

        const cdColor = cooldown === 0 ? '#10b981' : '#ef4444';
        const cdCell = `<span style="color:${cdColor};font-weight:600;">${cooldown}</span>`;

        const exitColor = exitColors[exitSig] || muted;
        const exitCell = exitSig !== 'none'
            ? `<span style="color:${exitColor};font-weight:600;background:rgba(255,255,255,0.05);padding:1px 4px;border-radius:3px;">${exitSig}</span>`
            : '<span style="color:' + muted + ';">\u2014</span>';

        bodyHtml += `<tr style="background:${rowBg};border-bottom:1px solid ${border};">
            <td style="padding:4px 8px;font-size:11px;white-space:nowrap;">${row.date}</td>
            <td style="padding:4px 6px;font-size:11px;">${swingCell}</td>
            <td style="padding:4px 6px;font-size:11px;text-align:center;">${entryCell}</td>
            <td style="padding:4px 6px;font-size:11px;">${dmCell}</td>
            <td style="padding:4px 6px;font-size:11px;text-align:right;">${adxCell}</td>
            <td style="padding:4px 6px;text-align:right;font-family:monospace;font-size:11px;">${strength}</td>
            <td style="padding:4px 6px;font-size:11px;">${topCell}</td>
            <td style="padding:4px 6px;font-size:11px;">${confBar}</td>
            <td style="padding:4px 6px;font-size:11px;text-align:right;">${atrCell}</td>
            <td style="padding:4px 6px;font-size:11px;text-align:center;">${cdCell}</td>
            <td style="padding:4px 6px;font-size:11px;">${exitCell}</td>
        </tr>`;
    }

    const historyTable = `
        <div style="margin-top:16px;">
            <h4 style="cursor:pointer;margin:0 0 8px 0;color:${muted};font-size:12px;text-transform:uppercase;"
                onclick="(function(el){
                    const t=el.nextElementSibling;
                    const show=t.style.display==='none';
                    t.style.display=show?'block':'none';
                    el.querySelector('span').textContent=show?'\u25bc':'\u25b6';
                })(this)">
                <span>\u25b6</span> Bar-by-Bar History (${rows.length} bars) — Click to expand
            </h4>
            <div style="display:none;">
                <div style="font-size:11px;color:${muted};margin-bottom:8px;">
                    Newest first ·
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(16,185,129,0.15);border:1px solid #10b981;border-radius:2px;vertical-align:middle;"></span> Entry
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(16,185,129,0.10);border:1px solid #10b981;border-radius:2px;vertical-align:middle;margin-left:8px;"></span> BUY
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(239,68,68,0.10);border:1px solid #ef4444;border-radius:2px;vertical-align:middle;margin-left:8px;"></span> SELL
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(168,85,247,0.10);border:1px solid #a855f7;border-radius:2px;vertical-align:middle;margin-left:8px;"></span> TOP
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;color:${colors.text};font-size:12px;">
                        <thead>
                            <tr style="background:${headerBg};border-bottom:2px solid ${border};">
                                <th style="padding:6px 8px;text-align:left;font-size:11px;color:${muted};cursor:help;" title="Bar timestamp">Date</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};cursor:help;" title="Causal ZIG/MA crossover signal.&#10;BUY: ZIG crosses above MA (bullish trend filter).&#10;SELL: ZIG crosses below MA.&#10;Cooldown: BUY suppressed for N bars after last BUY.">Swing</th>
                                <th style="padding:6px 6px;text-align:center;font-size:11px;color:${muted};cursor:help;" title="Composite entry signal. All conditions must be true:&#10;1. Swing = BUY&#10;2. Price > EMA99 (bullish trend)&#10;3. ADX >= 15 (no chop)&#10;4. Trend strength >= 0.30 (moderate+)&#10;5. MACD Trend = BULLISH or IMPROVING&#10;6. Cooldown = 0 (no recent exit)">Entry</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};cursor:help;" title="Dual MACD (55/89/34) structural trend state.&#10;Histogram = 2 × (EMA55 - EMA89 - Signal34).&#10;BULLISH: histogram > 0, slope > 0&#10;DETERIORATING: histogram > 0, slope < 0&#10;IMPROVING: histogram < 0, slope > 0&#10;BEARISH: histogram < 0, slope < 0">MACD Trend</th>
                                <th style="padding:6px 6px;text-align:right;font-size:11px;color:${muted};cursor:help;" title="Average Directional Index (25-period).&#10;Measures trend strength regardless of direction.&#10;Red background when < 15 (chop zone, entry blocked).&#10;> 25 = trending, > 40 = strong trend.">ADX</th>
                                <th style="padding:6px 6px;text-align:right;font-size:11px;color:${muted};cursor:help;" title="Normalized trend strength = ADX / 50.&#10;STRONG >= 0.60, MODERATE >= 0.30, WEAK < 0.30.&#10;Entry requires >= 0.30 (moderate).">Strength</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};cursor:help;" title="Williams %%R top detection system.&#10;TOP_PENDING: W%%R(13) > 70&#10;TOP_ZONE: W%%R mid declining from >80, short near peak&#10;TOP_DETECTED: W%%R long crosses above short + ADX declining&#10;Resets after W%%R mid < 60 for 3 bars.">Top</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};cursor:help;" title="4-factor confidence score (0-100%%).&#10;= 30%% × ZIG strength (ADX/50)&#10;+ 25%% × MACD health (BULL=1, IMPR=0.7, DET=0.3, BEAR=0)&#10;+ 25%% × EMA alignment (5-EMA stack ordering)&#10;+ 20%% × Vol quality (ADX filter × top penalty)">Conf(4f)</th>
                                <th style="padding:6px 6px;text-align:right;font-size:11px;color:${muted};cursor:help;" title="Informational trailing stop level.&#10;= Rolling max(close, 20 bars) - 3.5 × ATR(20).&#10;Not position-aware; shows per-bar level.&#10;Exit triggers when close < ATR stop.">ATR Stop</th>
                                <th style="padding:6px 6px;text-align:center;font-size:11px;color:${muted};cursor:help;" title="Cooldown bars remaining after an exit signal.&#10;Counts down from 5 to 0 after each exit.&#10;Green (0) = ready for new entry.&#10;Red (>0) = entry blocked.">CD</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};cursor:help;" title="Exit signal reason (first match wins):&#10;atr_stop: close < trailing ATR stop level&#10;dm_regime: 3 consecutive MACD BEARISH bars&#10;zig_sell: ZIG/MA cross down&#10;top_detected: Williams %%R top confirmed&#10;none: no exit condition">Exit</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = `<div style="padding:16px;">${summaryCard}${historyTable}</div>`;
}

// ========== RegimeFlex Strategy Section ==========
function updateRegimeFlexHistory(data) {
    const container = document.getElementById('regime-flex-table');
    if (!container) return;

    const rows = data.regime_flex_history || [];
    if (rows.length === 0) {
        container.innerHTML = '<div style="color: ' + colors.text_muted + '; padding: 16px;">No RegimeFlex history available for this symbol/timeframe.</div>';
        return;
    }

    const border = colors.border || '#334155';
    const muted = colors.text_muted || '#94a3b8';
    const headerBg = colors.bg || '#1e293b';
    const cardBg = colors.card_bg || '#1e293b';

    const regimeColors = {
        'R0': '#10b981',
        'R1': '#f59e0b',
        'R2': '#ef4444',
        'R3': '#a855f7',
    };
    const regimeLabels = {
        'R0': 'Healthy Uptrend',
        'R1': 'Choppy/Extended',
        'R2': 'Risk-Off',
        'R3': 'Rebound Window',
    };
    const signalBg = {
        'BUY': 'rgba(16, 185, 129, 0.10)',
        'SELL': 'rgba(239, 68, 68, 0.10)',
        'HOLD': 'transparent',
    };
    const signalColor = {
        'BUY': '#10b981',
        'SELL': '#ef4444',
        'HOLD': muted,
    };

    const cur = rows[0];
    const curRegime = cur.regime || '--';
    const curExposure = cur.target_exposure || 0;
    const curSignal = cur.signal || 'HOLD';
    const curRegimeColor = regimeColors[curRegime] || muted;
    const curRegimeLabel = regimeLabels[curRegime] || curRegime;

    let signalBadge;
    if (curSignal === 'BUY') {
        signalBadge = `<span style="background:rgba(16,185,129,0.2);color:#10b981;border:1px solid #10b981;padding:4px 12px;border-radius:6px;font-weight:700;">BUY</span>`;
    } else if (curSignal === 'SELL') {
        signalBadge = `<span style="background:rgba(239,68,68,0.2);color:#ef4444;border:1px solid #ef4444;padding:4px 12px;border-radius:6px;font-weight:700;">SELL</span>`;
    } else {
        signalBadge = `<span style="color:${muted};border:1px solid ${border};padding:4px 12px;border-radius:6px;">HOLD</span>`;
    }

    const exposureBarWidth = Math.min(curExposure, 100);
    const exposureColor = curExposure >= 80 ? '#10b981' : curExposure >= 40 ? '#f59e0b' : curExposure > 0 ? '#a855f7' : '#ef4444';

    const summaryCard = `
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:12px;">
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Current Regime</div>
                <div style="font-size:20px;font-weight:700;color:${curRegimeColor};">${curRegime}</div>
                <div style="font-size:11px;color:${muted};margin-top:4px;">${curRegimeLabel}</div>
            </div>
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Target Exposure</div>
                <div style="font-size:20px;font-weight:700;color:${exposureColor};">${curExposure}%</div>
                <div style="width:80%;height:6px;background:${border};border-radius:3px;overflow:hidden;margin:6px auto 0;">
                    <div style="width:${exposureBarWidth}%;height:100%;background:${exposureColor};border-radius:3px;"></div>
                </div>
            </div>
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Signal</div>
                <div style="margin-top:4px;">${signalBadge}</div>
            </div>
        </div>
        <div style="font-size:11px;color:${muted};margin-bottom:4px;">
            As of ${cur.date} \u00b7 ${data.symbol} \u00b7 ${data.timeframe}
        </div>
    `;

    let bodyHtml = '';
    for (const row of rows) {
        const regime = row.regime || '--';
        const sig = row.signal || 'HOLD';
        const rowBg = signalBg[sig] || 'transparent';
        const sigCol = signalColor[sig] || muted;
        const regCol = regimeColors[regime] || muted;
        const exposure = row.target_exposure || 0;
        const expColor = exposure >= 80 ? '#10b981' : exposure >= 40 ? '#f59e0b' : exposure > 0 ? '#a855f7' : '#ef4444';

        bodyHtml += `<tr style="background:${rowBg};border-bottom:1px solid ${border};">
            <td style="padding:4px 8px;font-size:11px;white-space:nowrap;">${row.date}</td>
            <td style="padding:4px 6px;font-size:11px;color:${regCol};font-weight:600;">${regime}</td>
            <td style="padding:4px 6px;font-size:11px;text-align:right;font-family:monospace;">
                <span style="color:${expColor};">${exposure}%</span>
            </td>
            <td style="padding:4px 6px;font-size:11px;color:${sigCol};font-weight:${sig !== 'HOLD' ? '600' : '400'};">${sig}</td>
        </tr>`;
    }

    const historyTable = `
        <div style="margin-top:16px;">
            <h4 style="cursor:pointer;margin:0 0 8px 0;color:${muted};font-size:12px;text-transform:uppercase;"
                onclick="(function(el){
                    const t=el.nextElementSibling;
                    const show=t.style.display==='none';
                    t.style.display=show?'block':'none';
                    el.querySelector('span').textContent=show?'\u25bc':'\u25b6';
                })(this)">
                <span>\u25b6</span> Bar-by-Bar History (${rows.length} bars) \u2014 Click to expand
            </h4>
            <div style="display:none;">
                <div style="font-size:11px;color:${muted};margin-bottom:8px;">
                    Newest first \u00b7
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(16,185,129,0.10);border:1px solid #10b981;border-radius:2px;vertical-align:middle;"></span> BUY
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(239,68,68,0.10);border:1px solid #ef4444;border-radius:2px;vertical-align:middle;margin-left:8px;"></span> SELL
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;color:${colors.text};font-size:12px;">
                        <thead>
                            <tr style="background:${headerBg};border-bottom:2px solid ${border};">
                                <th style="padding:6px 8px;text-align:left;font-size:11px;color:${muted};">Date</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};">Regime</th>
                                <th style="padding:6px 6px;text-align:right;font-size:11px;color:${muted};">Exposure</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};">Signal</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = `<div style="padding:16px;">${summaryCard}${historyTable}</div>`;
}

// ========== SectorPulse Strategy Section ==========
function updateSectorPulseHistory(data) {
    const container = document.getElementById('sector-pulse-table');
    if (!container) return;

    const rows = data.sector_pulse_history || [];
    if (rows.length === 0) {
        container.innerHTML = '<div style="color: ' + colors.text_muted + '; padding: 16px;">No SectorPulse history available for this symbol/timeframe.</div>';
        return;
    }

    const border = colors.border || '#334155';
    const muted = colors.text_muted || '#94a3b8';
    const headerBg = colors.bg || '#1e293b';
    const cardBg = colors.card_bg || '#1e293b';

    const regimeColors = {
        'R0': '#10b981',
        'R1': '#f59e0b',
        'R2': '#ef4444',
        'R3': '#a855f7',
    };

    const cur = rows[0];
    const curMomentum = cur.momentum_score || 0;
    const curRegime = cur.regime || '--';
    const curRegimeColor = regimeColors[curRegime] || muted;
    const momColor = curMomentum > 5 ? '#10b981' : curMomentum > 0 ? '#06b6d4' : curMomentum > -5 ? '#f59e0b' : '#ef4444';

    const summaryCard = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px;">
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">20-Day Momentum</div>
                <div style="font-size:24px;font-weight:700;color:${momColor};">
                    ${curMomentum >= 0 ? '+' : ''}${curMomentum.toFixed(2)}%
                </div>
                <div style="font-size:11px;color:${muted};margin-top:4px;">
                    ${curMomentum > 5 ? 'Strong upside' : curMomentum > 0 ? 'Mild upside' : curMomentum > -5 ? 'Mild downside' : 'Strong downside'}
                </div>
            </div>
            <div style="background:${cardBg};border:1px solid ${border};border-radius:10px;padding:16px;text-align:center;">
                <div style="font-size:10px;text-transform:uppercase;color:${muted};margin-bottom:6px;letter-spacing:0.5px;">Regime</div>
                <div style="font-size:20px;font-weight:700;color:${curRegimeColor};">${curRegime}</div>
                <div style="font-size:11px;color:${muted};margin-top:4px;">
                    ${curRegime === 'R0' ? 'Full allocation OK' : curRegime === 'R1' ? 'Reduced allocation' : curRegime === 'R2' ? 'No new positions' : curRegime === 'R3' ? 'Small positions only' : ''}
                </div>
            </div>
        </div>
        <div style="font-size:11px;color:${muted};margin-bottom:4px;">
            As of ${cur.date} \u00b7 ${data.symbol} \u00b7 ${data.timeframe}
        </div>
    `;

    let bodyHtml = '';
    for (const row of rows) {
        const mom = row.momentum_score || 0;
        const regime = row.regime || '--';
        const regCol = regimeColors[regime] || muted;
        const mC = mom > 5 ? '#10b981' : mom > 0 ? '#06b6d4' : mom > -5 ? '#f59e0b' : '#ef4444';
        const rowBg = mom > 5 ? 'rgba(16, 185, 129, 0.05)' : mom < -5 ? 'rgba(239, 68, 68, 0.05)' : 'transparent';

        bodyHtml += `<tr style="background:${rowBg};border-bottom:1px solid ${border};">
            <td style="padding:4px 8px;font-size:11px;white-space:nowrap;">${row.date}</td>
            <td style="padding:4px 6px;font-size:11px;text-align:right;font-family:monospace;color:${mC};">
                ${mom >= 0 ? '+' : ''}${mom.toFixed(2)}%
            </td>
            <td style="padding:4px 6px;font-size:11px;color:${regCol};font-weight:600;">${regime}</td>
        </tr>`;
    }

    const historyTable = `
        <div style="margin-top:16px;">
            <h4 style="cursor:pointer;margin:0 0 8px 0;color:${muted};font-size:12px;text-transform:uppercase;"
                onclick="(function(el){
                    const t=el.nextElementSibling;
                    const show=t.style.display==='none';
                    t.style.display=show?'block':'none';
                    el.querySelector('span').textContent=show?'\u25bc':'\u25b6';
                })(this)">
                <span>\u25b6</span> Bar-by-Bar History (${rows.length} bars) \u2014 Click to expand
            </h4>
            <div style="display:none;">
                <div style="font-size:11px;color:${muted};margin-bottom:8px;">
                    Newest first \u00b7
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(16,185,129,0.05);border:1px solid #10b981;border-radius:2px;vertical-align:middle;"></span> Strong upside (&gt;5%)
                    <span style="display:inline-block;width:10px;height:10px;background:rgba(239,68,68,0.05);border:1px solid #ef4444;border-radius:2px;vertical-align:middle;margin-left:8px;"></span> Strong downside (&lt;-5%)
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;color:${colors.text};font-size:12px;">
                        <thead>
                            <tr style="background:${headerBg};border-bottom:2px solid ${border};">
                                <th style="padding:6px 8px;text-align:left;font-size:11px;color:${muted};">Date</th>
                                <th style="padding:6px 6px;text-align:right;font-size:11px;color:${muted};" title="20-day return (momentum score)">Momentum</th>
                                <th style="padding:6px 6px;text-align:left;font-size:11px;color:${muted};">Regime</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = `<div style="padding:16px;">${summaryCard}${historyTable}</div>`;
}

// Set timeframe
function setTimeframe(tf) {
    CONFIG.currentTimeframe = tf;

    // Update button states
    document.querySelectorAll('.tf-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tf === tf);
    });

    updateChart();
}

// Toggle section visibility - handles both string ID and DOM element (for regime report sections)
function toggleSection(arg) {
    if (typeof arg === 'string') {
        // Original behavior: arg is content ID
        const content = document.getElementById(arg);
        if (!content) return;
        const header = content.previousElementSibling;
        const icon = header ? header.querySelector('.toggle-icon') : null;

        content.classList.toggle('collapsed');
        if (icon) {
            icon.style.transform = content.classList.contains('collapsed') ? 'rotate(-90deg)' : 'rotate(0deg)';
        }
    } else {
        // New behavior: arg is the header element (from onclick="toggleSection(this)")
        const header = arg;
        const section = header.parentElement;
        if (!section || !section.classList.contains('report-section')) return;

        section.classList.toggle('collapsed');
        const indicator = header.querySelector('.collapse-indicator');
        if (indicator) {
            indicator.textContent = section.classList.contains('collapsed') ? '▶' : '▼';
        }
    }
}

// Load and render indicators section
async function loadIndicatorsSection() {
    const container = document.getElementById('indicators-content');
    if (!container) return;

    try {
        const response = await fetch('data/indicators.json');
        if (!response.ok) {
            container.innerHTML = '<div class="no-indicators">Indicators data not available</div>';
            return;
        }
        const data = await response.json();
        renderIndicatorsSection(container, data);
    } catch (error) {
        console.error('Failed to load indicators:', error);
        container.innerHTML = '<div class="no-indicators">Failed to load indicators</div>';
    }
}

function renderIndicatorsSection(container, data) {
    if (!data.categories || data.categories.length === 0) {
        container.innerHTML = '<div class="no-indicators">No indicators configured</div>';
        return;
    }

    let html = '';
    for (const category of data.categories) {
        html += `
            <div class="category-group">
                <div class="category-title">${category.name}</div>
                <div class="indicator-cards">
        `;

        for (const ind of category.indicators) {
            const paramsStr = Object.entries(ind.params || {})
                .map(([k, v]) => `${k}=${v}`)
                .join(', ');

            let rulesHtml = '';
            if (ind.rules && ind.rules.length > 0) {
                rulesHtml = '<div class="rules"><h4>Rules</h4>';
                for (const rule of ind.rules) {
                    rulesHtml += `
                        <div class="rule-item">
                            <span class="rule-name direction-${rule.direction}">${rule.id}</span>
                            <div class="rule-desc">${rule.description}</div>
                        </div>
                    `;
                }
                rulesHtml += '</div>';
            }

            html += `
                <div class="indicator-card">
                    <h3>${ind.name}</h3>
                    <div class="description">${ind.description}${paramsStr ? '. Params: ' + paramsStr : ''}</div>
                    ${rulesHtml}
                </div>
            `;
        }

        html += '</div></div>';
    }

    container.innerHTML = html;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    // Parse URL query parameters to set initial symbol (e.g., ?symbol=NVDA)
    const urlParams = new URLSearchParams(window.location.search);
    const symbolParam = urlParams.get('symbol');
    if (symbolParam && CONFIG.symbols.includes(symbolParam)) {
        CONFIG.currentSymbol = symbolParam;
        const selectEl = document.getElementById('symbol-select');
        if (selectEl) selectEl.value = symbolParam;
    }

    loadSummary();
    loadIndicatorsSection();

    // Set initial timeframe button
    const initialTf = CONFIG.currentTimeframe;
    document.querySelectorAll('.tf-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tf === initialTf);
    });
});

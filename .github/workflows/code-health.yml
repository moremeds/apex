# Weekly Code Health Report
# Generates a comprehensive code quality report and creates a GitHub Issue
# Includes: dead code (vulture), complexity (radon), duplicates (jscpd)

name: Weekly Code Health

on:
  schedule:
    - cron: '0 9 * * 1'  # Monday 9 AM UTC
  workflow_dispatch:      # Allow manual trigger

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Generate Code Health Report
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  report:
    name: Generate Report
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install quality tools
        run: uv pip install --system vulture radon

      - name: Generate code health report
        run: |
          echo "# ðŸ“Š Code Health Report - $(date +%Y-%m-%d)" > CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo "Weekly automated code quality analysis for APEX." >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md

          # Dead Code Section
          echo "## ðŸ§¹ Dead Code (vulture)" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo "Potentially unused code detected with confidence â‰¥80%:" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          vulture src/ --min-confidence 80 --exclude "src/legacy/,src/verification/" --sort-by-size 2>&1 | head -50 >> CODE_HEALTH.md || echo "No dead code detected!" >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md

          # Complexity Section
          echo "## ðŸ“ˆ Cyclomatic Complexity (radon)" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo "Functions/methods ranked by complexity (A=simple, F=very complex):" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          radon cc src/ -a -nc --total-average >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md

          # Most Complex Functions
          echo "### Top 10 Most Complex Functions" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          radon cc src/ -s -n C | head -30 >> CODE_HEALTH.md || echo "All functions have acceptable complexity!" >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md

          # Maintainability Section
          echo "## ðŸ”§ Maintainability Index (radon)" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo "Files ranked by maintainability (A=best, C=needs attention):" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          radon mi src/ -s | grep -E "^src.*[BC]$" | sort -t'-' -k2 | head -20 >> CODE_HEALTH.md || echo "All files have good maintainability!" >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md

          # Raw Metrics
          echo "## ðŸ“Š Raw Metrics Summary" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          radon raw src/ -s | tail -10 >> CODE_HEALTH.md
          echo '```' >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md

          echo "---" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo "ðŸ¤– *This report was automatically generated by the code-health workflow*" >> CODE_HEALTH.md
          echo "" >> CODE_HEALTH.md
          echo "**Actions:**" >> CODE_HEALTH.md
          echo "- Review dead code findings and remove unused code" >> CODE_HEALTH.md
          echo "- Consider refactoring functions with C+ complexity" >> CODE_HEALTH.md
          echo "- Use \`make quality\` locally to run these checks" >> CODE_HEALTH.md

      - name: Create GitHub Issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸ“Š Weekly Code Health Report - ${{ github.run_id }}"
          content-filepath: CODE_HEALTH.md
          labels: |
            code-quality
            automated
            weekly-report

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Duplicate Code Detection (separate job for clarity)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  duplicates:
    name: Detect Duplicates
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install jscpd
        run: npm install -g jscpd

      - name: Check for duplicate code
        id: jscpd
        run: |
          mkdir -p .jscpd-report

          # Run jscpd and capture exit code
          jscpd src/ \
            --min-lines 10 \
            --min-tokens 50 \
            --threshold 5 \
            --reporters console,markdown \
            --output .jscpd-report/ \
            --ignore "**/__pycache__/**,**/legacy/**,**/verification/**" \
            || true

          # Check if report has content
          if [ -f ".jscpd-report/jscpd-report.md" ] && [ -s ".jscpd-report/jscpd-report.md" ]; then
            echo "has_duplicates=true" >> $GITHUB_OUTPUT
          else
            echo "has_duplicates=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare duplicate report
        if: steps.jscpd.outputs.has_duplicates == 'true'
        run: |
          echo "# ðŸ”„ Duplicate Code Detected" > DUPLICATES.md
          echo "" >> DUPLICATES.md
          echo "The following code duplications were found in the codebase:" >> DUPLICATES.md
          echo "" >> DUPLICATES.md
          cat .jscpd-report/jscpd-report.md >> DUPLICATES.md
          echo "" >> DUPLICATES.md
          echo "---" >> DUPLICATES.md
          echo "" >> DUPLICATES.md
          echo "**Recommendations:**" >> DUPLICATES.md
          echo "- Extract duplicated code into shared functions/modules" >> DUPLICATES.md
          echo "- Consider creating utility classes for common patterns" >> DUPLICATES.md
          echo "- Mark false positives with `# jscpd:ignore-start` / `# jscpd:ignore-end`" >> DUPLICATES.md
          echo "" >> DUPLICATES.md
          echo "ðŸ¤– *This issue was automatically created by the code-health workflow*" >> DUPLICATES.md

      - name: Create duplicate code issue
        if: steps.jscpd.outputs.has_duplicates == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸ”„ Duplicate Code Detected - ${{ github.run_id }}"
          content-filepath: DUPLICATES.md
          labels: |
            code-quality
            duplicate-code
            automated

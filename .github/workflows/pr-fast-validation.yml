name: "PR: Fast Validation"

on:
  pull_request:
    paths:
      - 'src/domain/signals/indicators/regime/**'
      - 'src/domain/signals/validation/**'
      - 'src/runners/validation_runner.py'
      - 'config/validation/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fast-validation:
    name: Fast Regime Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run Fast Validation
        run: |
          source .venv/bin/activate
          # Use --synthetic to avoid Yahoo Finance API rate limiting in CI
          # Synthetic data exercises the same validation logic with deterministic data
          python -m src.runners.validation_runner fast \
            --symbols SPY QQQ AAPL MSFT NVDA \
            --timeframes 1d \
            --folds 2 \
            --no-optuna \
            --synthetic \
            --output ci_fast.json

      - name: Validate Output Structure
        run: |
          source .venv/bin/activate
          python -c "
          import json
          import sys

          with open('ci_fast.json') as f:
              data = json.load(f)

          # Validate output structure
          required_keys = ['version', 'mode', 'generated_at', 'gate_results', 'all_gates_passed', 'universe']
          missing = [k for k in required_keys if k not in data]
          if missing:
              print(f'ERROR: Missing required keys: {missing}')
              sys.exit(1)

          # Validate gate results exist
          gate_names = {g['gate_name'] for g in data['gate_results']}
          expected_gates = {'trending_r0', 'choppy_r0', 'causality_g7'}
          if not expected_gates.issubset(gate_names):
              print(f'ERROR: Missing expected gates: {expected_gates - gate_names}')
              sys.exit(1)

          print('Gate Results (with synthetic data):')
          print('-' * 40)
          for gate in data['gate_results']:
              status = '✓ PASS' if gate['passed'] else '○ INFO'
              print(f\"  {gate['gate_name']}: {status}\")

          # Key invariant: causality must pass (trending > choppy)
          # This validates the scientific correctness of the detector
          causality_gate = next((g for g in data['gate_results'] if g['gate_name'] == 'causality_g7'), None)
          if causality_gate and not causality_gate['passed']:
              print()
              print('ERROR: Causality gate FAILED - detector is not distinguishing regimes!')
              sys.exit(1)

          print()
          print('Output structure valid, causality invariant holds')
          "

      - name: Upload Fast Validation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fast-validation-report
          path: ci_fast.json
          retention-days: 7

name: "Release: Holdout Validation"

on:
  release:
    types: [published]
  workflow_dispatch:  # Manual trigger

jobs:
  holdout-validation:
    name: Holdout Universe Validation
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache TA-Lib
        id: cache-talib
        uses: actions/cache@v4
        with:
          path: ~/ta-lib-install
          key: talib-0.6.4-${{ runner.os }}-${{ runner.arch }}

      - name: Install TA-Lib C library
        run: |
          if [ -d "$HOME/ta-lib-install/lib" ]; then
            echo "Restoring TA-Lib from cache..."
            sudo cp -r $HOME/ta-lib-install/lib/* /usr/lib/
            sudo cp -r $HOME/ta-lib-install/include/* /usr/include/
            sudo ldconfig
          else
            echo "Building TA-Lib 0.6.4 from source..."
            sudo apt-get update
            sudo apt-get install -y wget build-essential
            wget https://github.com/ta-lib/ta-lib/releases/download/v0.6.4/ta-lib-0.6.4-src.tar.gz
            tar -xzf ta-lib-0.6.4-src.tar.gz
            cd ta-lib-0.6.4 && ./configure --prefix=/usr && make -j$(nproc) && sudo make install
            sudo ldconfig
            mkdir -p $HOME/ta-lib-install/lib $HOME/ta-lib-install/include
            cp -r /usr/lib/libta* $HOME/ta-lib-install/lib/ 2>/dev/null || true
            cp -r /usr/include/ta-lib $HOME/ta-lib-install/include/ 2>/dev/null || true
          fi

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run Holdout Validation
        run: |
          source .venv/bin/activate
          python -m src.runners.validation_runner holdout \
            --universe config/validation/regime_universe.yaml \
            --timeframes 1d 4h \
            --output reports/holdout_validation.json

      - name: Validate Holdout Gates
        run: |
          source .venv/bin/activate
          python -c "
          import json
          import sys

          with open('reports/holdout_validation.json') as f:
              data = json.load(f)

          print('=' * 60)
          print('HOLDOUT VALIDATION (Release Gate)')
          print('=' * 60)
          print()
          print(f\"Mode: {data.get('mode', 'unknown')}\")
          print(f\"Generated: {data.get('generated_at', 'unknown')}\")
          print()

          # For now, holdout is a placeholder
          # In production, this would validate against the same thresholds as nightly
          if 'gate_results' in data:
              print('Gate Results:')
              print('-' * 40)
              for gate in data['gate_results']:
                  status = '✓ PASS' if gate['passed'] else '✗ FAIL'
                  print(f\"  {gate['gate_name']}: {status}\")

              if not data.get('all_gates_passed', True):
                  print()
                  print('ERROR: Holdout validation failed!')
                  sys.exit(1)

          print()
          print('Holdout validation PASSED')
          "

      - name: Upload Holdout Validation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: holdout-validation-report
          path: reports/holdout_validation.json
          retention-days: 90

      - name: Fail Release on Validation Failure
        if: failure()
        run: |
          echo "::error::Holdout validation failed! Release should not proceed."
          exit 1

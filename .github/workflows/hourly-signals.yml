name: "Intraday: Signal Reports"

# ═══════════════════════════════════════════════════════════════════════════
# Signal report generation during market hours.
#
# DST-safe design: Cron triggers cover BOTH EDT (UTC-4) and EST (UTC-5).
# The Python market-check step uses America/New_York timezone to classify
# each run by ET time window, so NO manual DST switching is needed.
#
# ET time windows (with ~45min tolerance for GHA startup delays):
#   8:00-9:29am ET:   First report (1H+4H+1D + strategy comparison)
#   10am-12:59pm ET:  Intraday hourly (1H only)
#   1:00-1:59pm ET:   4H bar close (1H+4H)
#   2:00-3:59pm ET:   Intraday hourly (1H only)
#   4:00-5:59pm ET:   Post-close (1H+4H+1D, no retrain)
#
# Pipeline:
#   Step 1: Update market caps
#   Step 2: Retrain models (skipped at post-close)
#   Step 3: Generate and deploy report
#
# Email: Plain-text TUI-formatted report (monospace, mobile-friendly)
# ═══════════════════════════════════════════════════════════════════════════

on:
  schedule:
    # DST-safe schedule — covers both EDT (UTC-4) and EST (UTC-5).
    # Python market-check decides what to run based on ET time.
    # Duplicate crons (e.g. 12+13) ensure at least one fires per DST season.
    - cron: '30 12,13 * * 1-5'    # First report 8:30am ET (EDT→12:30, EST→13:30)
    - cron: '0 14-21 * * 1-5'     # Hourly: covers 9am-5pm ET across both DST seasons
    - cron: '30 17,18 * * 1-5'    # 4H close 1:30pm ET (EDT→17:30, EST→18:30)
    - cron: '15 20,21 * * 1-5'    # Post-close 4:15pm ET (EDT→20:15, EST→21:15)
  workflow_dispatch:
    inputs:
      run_strategy_compare:
        description: "Also run strategy comparison backtests"
        type: boolean
        default: false

concurrency:
  group: hourly-signals
  cancel-in-progress: true  # Cancel if previous run still running

permissions:
  contents: write  # Required to push to gh-pages branch

env:
  PYTHON_VERSION: '3.13'
  UNIVERSE: config/universe.yaml

jobs:
  generate-report:
    name: Generate Signal Report
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Longer timeout for retraining
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache TA-Lib
        id: cache-talib
        uses: actions/cache@v4
        with:
          path: ~/ta-lib-install
          key: talib-0.6.4-${{ runner.os }}-${{ runner.arch }}

      - name: Install TA-Lib
        run: |
          if [ -d "$HOME/ta-lib-install/lib" ]; then
            echo "Restoring TA-Lib from cache..."
            sudo cp -r $HOME/ta-lib-install/lib/* /usr/lib/
            sudo cp -r $HOME/ta-lib-install/include/* /usr/include/
            sudo ldconfig
          else
            echo "Building TA-Lib 0.6.4 from source..."
            sudo apt-get update && sudo apt-get install -y wget build-essential
            wget https://github.com/ta-lib/ta-lib/releases/download/v0.6.4/ta-lib-0.6.4-src.tar.gz
            tar -xzf ta-lib-0.6.4-src.tar.gz
            cd ta-lib-0.6.4 && ./configure --prefix=/usr && make -j$(nproc) && sudo make install
            sudo ldconfig
            mkdir -p $HOME/ta-lib-install/lib $HOME/ta-lib-install/include
            cp -r /usr/lib/libta* $HOME/ta-lib-install/lib/ 2>/dev/null || true
            cp -r /usr/include/ta-lib $HOME/ta-lib-install/include/ 2>/dev/null || true
          fi

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev,observability]"

      - name: Check market open
        id: market-check
        env:
          INPUT_RUN_STRATEGY_COMPARE: ${{ inputs.run_strategy_compare || 'false' }}
        run: |
          source .venv/bin/activate
          python << 'EOF'
          import pandas_market_calendars as mcal
          from datetime import date, datetime, timezone
          from zoneinfo import ZoneInfo
          import os

          nyse = mcal.get_calendar('NYSE')
          today = date.today()
          schedule = nyse.schedule(start_date=today, end_date=today)

          is_trading_day = not schedule.empty
          is_manual = os.environ.get('GITHUB_EVENT_NAME') == 'workflow_dispatch'

          # ── DST-safe classification using ET timezone ─────────────────
          # Uses America/New_York (auto-switches EDT/EST) instead of UTC
          # hour matching. Range-based windows handle GHA startup delays
          # of up to ~45 minutes gracefully.
          et_now = datetime.now(ZoneInfo("America/New_York"))
          et_hour = et_now.hour
          et_time = et_now.strftime("%-I:%M %p ET")
          et_date = et_now.strftime("%b %d")

          # ET time windows:
          #   <8am:         Too early (skip)
          #   8-9am:        First report (1H+4H+1D + strategy comparison)
          #   10am-12pm:    Intraday hourly (1H only)
          #   1-1:59pm:     4H bar close (1H+4H)
          #   2-3:59pm:     Intraday hourly (1H only)
          #   4-5:59pm:     Post-close (1H+4H+1D, no retrain)
          #   >=6pm:        Too late (skip)
          is_first    = 8 <= et_hour < 10
          is_4h_close = 13 <= et_hour < 14
          is_close    = 16 <= et_hour < 18
          is_hourly   = (10 <= et_hour < 13) or (14 <= et_hour < 16)
          in_window   = is_first or is_4h_close or is_close or is_hourly

          # Manual dispatch: check workflow_dispatch input for comparison toggle
          manual_compare = os.environ.get('INPUT_RUN_STRATEGY_COMPARE', 'false') == 'true'

          if is_manual:
              should_run = True
              should_retrain = True
              send_1h = "true"
              send_4h = "true"
              send_1d = "true"
              run_strategy_compare = "true" if manual_compare else "false"
              label = f"Manual dispatch (compare={'on' if manual_compare else 'off'}, market {'open' if is_trading_day else 'closed'})"
          elif not is_trading_day or not in_window:
              should_run = False
              should_retrain = False
              send_1h = "false"
              send_4h = "false"
              send_1d = "false"
              run_strategy_compare = "false"
              reason = "closed" if not is_trading_day else f"outside window (ET {et_hour}:{et_now.minute:02d})"
              label = f"SKIP: market {reason}"
          elif is_first:
              # First report: full signals + strategy comparison
              should_run = True
              should_retrain = True
              send_1h = "true"
              send_4h = "true"
              send_1d = "true"
              run_strategy_compare = "true"
              label = f"FIRST REPORT ({et_time})"
          elif is_close:
              # Post-close: full signals, no retrain
              should_run = True
              should_retrain = False
              send_1h = "true"
              send_4h = "true"
              send_1d = "true"
              run_strategy_compare = "false"
              label = f"POST-CLOSE ({et_time})"
          elif is_4h_close:
              # 4H bar close: 1H + 4H
              should_run = True
              should_retrain = True
              send_1h = "true"
              send_4h = "true"
              send_1d = "false"
              run_strategy_compare = "false"
              label = f"4H CLOSE ({et_time})"
          else:
              # Regular hourly: 1H only
              should_run = True
              should_retrain = True
              send_1h = "true"
              send_4h = "false"
              send_1d = "false"
              run_strategy_compare = "false"
              label = f"HOURLY ({et_time})"

          # Always generate all timeframes (partial bars are useful)
          timeframes = "1d 4h 1h"

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'should_run={str(should_run).lower()}\n')
              f.write(f'should_retrain={str(should_retrain).lower()}\n')
              f.write(f'send_1h={send_1h}\n')
              f.write(f'send_4h={send_4h}\n')
              f.write(f'send_1d={send_1d}\n')
              f.write(f'run_strategy_compare={run_strategy_compare}\n')
              f.write(f'timeframes={timeframes}\n')
              f.write(f'et_time={et_time}\n')
              f.write(f'et_date={et_date}\n')
          print(label)
          EOF

      # === PIPELINE ===

      - name: "Step 1/3: Update market caps"
        if: steps.market-check.outputs.should_run == 'true'
        run: |
          source .venv/bin/activate
          python -m src.runners.signal_runner --update-market-caps \
            --universe ${{ env.UNIVERSE }}
        env:
          LOG_LEVEL: WARNING

      - name: "Step 2/3: Retrain models"
        if: steps.market-check.outputs.should_retrain == 'true'
        run: |
          source .venv/bin/activate
          python -m src.runners.signal_runner --retrain-models \
            --universe ${{ env.UNIVERSE }}
        env:
          LOG_LEVEL: WARNING

      - name: Fetch existing score history from gh-pages
        if: steps.market-check.outputs.should_run == 'true'
        continue-on-error: true
        run: |
          mkdir -p out/signals/data
          git fetch origin gh-pages --depth=1 2>/dev/null || true
          git show origin/gh-pages:data/score_history.json > out/signals/data/score_history.json 2>/dev/null || echo '{"snapshots":[]}' > out/signals/data/score_history.json

      - name: "Step 3/3: Generate and deploy report"
        if: steps.market-check.outputs.should_run == 'true'
        run: |
          source .venv/bin/activate
          python -m src.runners.signal_runner --live \
            --universe ${{ env.UNIVERSE }} \
            --timeframes ${{ steps.market-check.outputs.timeframes }} \
            --format package \
            --html-output out/signals \
            --deploy github
        env:
          LOG_LEVEL: WARNING
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # === STRATEGY COMPARISON (first report of day, ~8:30am ET) ===

      - name: "Run strategy comparison backtests"
        if: steps.market-check.outputs.run_strategy_compare == 'true'
        run: |
          source .venv/bin/activate
          python -m src.runners.strategy_compare_runner \
            --universe ${{ env.UNIVERSE }} \
            --years 3 \
            --output out/signals/strategies.html
        env:
          LOG_LEVEL: WARNING

      - name: "Deploy strategies.html to gh-pages"
        if: steps.market-check.outputs.run_strategy_compare == 'true'
        run: |
          git fetch origin gh-pages --depth=1 2>/dev/null || true
          rm -rf /tmp/strategy-deploy
          # Clone existing gh-pages content, then overwrite strategies.html
          git clone --branch gh-pages --single-branch --depth 1 \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" \
            /tmp/strategy-deploy 2>/dev/null || \
            (mkdir -p /tmp/strategy-deploy && cd /tmp/strategy-deploy && git init -b gh-pages)
          cp out/signals/strategies.html /tmp/strategy-deploy/strategies.html
          cd /tmp/strategy-deploy && \
            git add strategies.html && \
            git diff --cached --quiet || \
            (git -c user.name="github-actions[bot]" \
                 -c user.email="github-actions[bot]@users.noreply.github.com" \
             commit -m "Update strategy comparison $(date +%Y-%m-%d)" && \
             git push origin gh-pages)
          rm -rf /tmp/strategy-deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # === RENDER EMAILS ===

      - name: Render email content
        if: steps.market-check.outputs.should_run == 'true'
        run: |
          source .venv/bin/activate
          python << 'PYEOF'
          from src.infrastructure.reporting.email_heatmap_renderer import render_email_text
          import os

          reports = []
          if os.environ.get("SEND_1H") == "true":
              reports.append(("1h", "Intraday 1H"))
          if os.environ.get("SEND_4H") == "true":
              reports.append(("4h", "Intraday 4H"))
          if os.environ.get("SEND_1D") == "true":
              reports.append(("1d", "End of Day"))

          for tag, label in reports:
              text = render_email_text(
                  "out/signals/data/summary.json",
                  history_path="out/signals/data/score_history.json",
                  report_label=label,
                  display_timezone="Asia/Hong_Kong",
              )
              with open(f"email_body_{tag}.txt", "w") as f:
                  f.write(text)
              print(f"Rendered {tag} email ({len(text)} chars)")
          PYEOF
        env:
          SEND_1H: ${{ steps.market-check.outputs.send_1h }}
          SEND_4H: ${{ steps.market-check.outputs.send_4h }}
          SEND_1D: ${{ steps.market-check.outputs.send_1d }}

      # === SEND EMAILS ===

      - name: "Send email: 1H"
        if: steps.market-check.outputs.send_1h == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT || 587 }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "APEX Intraday 1H — ${{ steps.market-check.outputs.et_date }} ${{ steps.market-check.outputs.et_time }}"
          to: ${{ secrets.SIGNAL_REPORT_RECIPIENTS }}
          from: "APEX Signal Bot <${{ secrets.SMTP_USERNAME }}>"
          body: file://${{ github.workspace }}/email_body_1h.txt
          content_type: text/plain
          convert_markdown: false

      - name: "Send email: 4H"
        if: steps.market-check.outputs.send_4h == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT || 587 }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "APEX Intraday 4H — ${{ steps.market-check.outputs.et_date }} ${{ steps.market-check.outputs.et_time }}"
          to: ${{ secrets.SIGNAL_REPORT_RECIPIENTS }}
          from: "APEX Signal Bot <${{ secrets.SMTP_USERNAME }}>"
          body: file://${{ github.workspace }}/email_body_4h.txt
          content_type: text/plain
          convert_markdown: false

      - name: "Send email: 1D"
        if: steps.market-check.outputs.send_1d == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT || 587 }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "APEX End of Day — ${{ steps.market-check.outputs.et_date }} ${{ steps.market-check.outputs.et_time }}"
          to: ${{ secrets.SIGNAL_REPORT_RECIPIENTS }}
          from: "APEX Signal Bot <${{ secrets.SMTP_USERNAME }}>"
          body: file://${{ github.workspace }}/email_body_1d.txt
          content_type: text/plain
          convert_markdown: false

      - name: Holiday notice
        if: steps.market-check.outputs.should_run != 'true' && steps.market-check.outputs.run_strategy_compare != 'true'
        run: echo "::notice::Market is closed today. Skipping report generation."

      - name: Upload report artifact
        if: steps.market-check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: signal-report-${{ github.run_id }}
          path: out/signals/
          if-no-files-found: warn
          retention-days: 7

name: "Intraday: Signal Reports"

# ═══════════════════════════════════════════════════════════════════════════
# Signal report generation during market hours.
#
# Schedule: 8:30am, 10am–3pm hourly, 1:30pm (4H), 4:15pm ET (Mon-Fri)
#
# All timeframes (1h, 4h, 1d) are always generated. Unfinished bars use
# the current spot price as close (partial/potential signals).
#
# Intraday emails show the primary 1H TrendPulse plus "Potential Daily"
# signals derived from the partial 1D bar.
#
# Daily email breakdown:
#   8:30am ET:        1H + 4H + 1D (first report, catches overnight changes)
#   10am–3pm ET:      Intraday 1H email (every hour on the hour)
#   1:30pm ET:        Intraday 4H (first 4H bar close)
#   4:15pm ET:        1H + 4H + 1D (post-close, end of day report)
#
# Pipeline:
#   Step 1: Update market caps
#   Step 2: Retrain models (not at close)
#   Step 3: Generate and deploy report
#
# Email: Plain-text TUI-formatted report (monospace, mobile-friendly)
# ═══════════════════════════════════════════════════════════════════════════

on:
  schedule:
    # Market hours schedule (UTC = ET + 5 in EST, ET + 4 in EDT)
    - cron: '30 13 * * 1-5'     # 8:30am ET — first report (1H+4H+1D, catches overnight)
    - cron: '0 15-20 * * 1-5'   # 10am–3pm ET — every hour on the hour (1H)
    - cron: '30 18 * * 1-5'     # 1:30pm ET — 4H bar close report
    - cron: '15 21 * * 1-5'     # 4:15pm ET — end of day report (1H+4H+1D)
  workflow_dispatch:

concurrency:
  group: hourly-signals
  cancel-in-progress: true  # Cancel if previous run still running

permissions:
  contents: write  # Required to push to gh-pages branch

env:
  PYTHON_VERSION: '3.13'
  UNIVERSE: config/universe.yaml

jobs:
  generate-report:
    name: Generate Signal Report
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Longer timeout for retraining
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache TA-Lib
        id: cache-talib
        uses: actions/cache@v4
        with:
          path: ~/ta-lib-install
          key: talib-0.6.4-${{ runner.os }}-${{ runner.arch }}

      - name: Install TA-Lib
        run: |
          if [ -d "$HOME/ta-lib-install/lib" ]; then
            echo "Restoring TA-Lib from cache..."
            sudo cp -r $HOME/ta-lib-install/lib/* /usr/lib/
            sudo cp -r $HOME/ta-lib-install/include/* /usr/include/
            sudo ldconfig
          else
            echo "Building TA-Lib 0.6.4 from source..."
            sudo apt-get update && sudo apt-get install -y wget build-essential
            wget https://github.com/ta-lib/ta-lib/releases/download/v0.6.4/ta-lib-0.6.4-src.tar.gz
            tar -xzf ta-lib-0.6.4-src.tar.gz
            cd ta-lib-0.6.4 && ./configure --prefix=/usr && make -j$(nproc) && sudo make install
            sudo ldconfig
            mkdir -p $HOME/ta-lib-install/lib $HOME/ta-lib-install/include
            cp -r /usr/lib/libta* $HOME/ta-lib-install/lib/ 2>/dev/null || true
            cp -r /usr/include/ta-lib $HOME/ta-lib-install/include/ 2>/dev/null || true
          fi

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev,observability]"

      - name: Check market open
        id: market-check
        run: |
          source .venv/bin/activate
          python << 'EOF'
          import pandas_market_calendars as mcal
          from datetime import date, datetime, timezone
          from zoneinfo import ZoneInfo
          import os

          nyse = mcal.get_calendar('NYSE')
          today = date.today()
          schedule = nyse.schedule(start_date=today, end_date=today)

          is_trading_day = not schedule.empty
          is_manual = os.environ.get('GITHUB_EVENT_NAME') == 'workflow_dispatch'
          now_utc = datetime.now(timezone.utc)
          utc_hour = now_utc.hour
          utc_min = now_utc.minute

          # Schedule: 8:30am, 10am-3pm hourly, 1:30pm (4H), 4:15pm ET
          # All timeframes always generated (partial bars use spot price)
          is_close = utc_hour == 21 and utc_min >= 10  # 4:15pm ET (end of day)
          is_first = utc_hour == 13  # 8:30am ET (first report)
          is_4h_close = utc_hour == 18 and utc_min == 30  # 1:30pm ET (4H bar close)
          is_4h_bar = is_4h_close or is_close or is_first

          if is_manual:
              should_run = True
              should_retrain = True
              send_1h = "true"
              send_4h = "true"
              send_1d = "true"
          else:
              should_run = is_trading_day
              should_retrain = should_run and not is_close
              send_1h = "true" if is_trading_day else "false"
              send_4h = "true" if is_trading_day and is_4h_bar else "false"
              send_1d = "true" if is_trading_day and (is_close or is_first) else "false"

          # Always generate all timeframes (partial bars are useful)
          timeframes = "1d 4h 1h"

          # ET timestamp for subject line
          et_now = datetime.now(ZoneInfo("America/New_York"))
          et_time = et_now.strftime("%-I:%M %p ET")
          et_date = et_now.strftime("%b %d")

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'should_run={str(should_run).lower()}\n')
              f.write(f'should_retrain={str(should_retrain).lower()}\n')
              f.write(f'send_1h={send_1h}\n')
              f.write(f'send_4h={send_4h}\n')
              f.write(f'send_1d={send_1d}\n')
              f.write(f'timeframes={timeframes}\n')
              f.write(f'et_time={et_time}\n')
              f.write(f'et_date={et_date}\n')
          if is_manual:
              print(f"Manual dispatch — forcing run (market {'open' if is_trading_day else 'closed'} on {today})")
          else:
              print(f"Market {'OPEN' if is_trading_day else 'CLOSED'} | 1H={send_1h} 4H={send_4h} 1D={send_1d} | tf={timeframes}")
          EOF

      # === PIPELINE ===

      - name: "Step 1/3: Update market caps"
        if: steps.market-check.outputs.should_run == 'true'
        run: |
          source .venv/bin/activate
          python -m src.runners.signal_runner --update-market-caps \
            --universe ${{ env.UNIVERSE }}
        env:
          LOG_LEVEL: WARNING

      - name: "Step 2/3: Retrain models"
        if: steps.market-check.outputs.should_retrain == 'true'
        run: |
          source .venv/bin/activate
          python -m src.runners.signal_runner --retrain-models \
            --universe ${{ env.UNIVERSE }}
        env:
          LOG_LEVEL: WARNING

      - name: Fetch existing score history from gh-pages
        if: steps.market-check.outputs.should_run == 'true'
        continue-on-error: true
        run: |
          mkdir -p out/signals/data
          git fetch origin gh-pages --depth=1 2>/dev/null || true
          git show origin/gh-pages:data/score_history.json > out/signals/data/score_history.json 2>/dev/null || echo '{"snapshots":[]}' > out/signals/data/score_history.json

      - name: "Step 3/3: Generate and deploy report"
        if: steps.market-check.outputs.should_run == 'true'
        run: |
          source .venv/bin/activate
          python -m src.runners.signal_runner --live \
            --universe ${{ env.UNIVERSE }} \
            --timeframes ${{ steps.market-check.outputs.timeframes }} \
            --format package \
            --html-output out/signals \
            --deploy github
        env:
          LOG_LEVEL: WARNING
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # === RENDER EMAILS ===

      - name: Render email content
        if: steps.market-check.outputs.should_run == 'true'
        run: |
          source .venv/bin/activate
          python << 'PYEOF'
          from src.infrastructure.reporting.email_heatmap_renderer import render_email_text
          import os

          reports = []
          if os.environ.get("SEND_1H") == "true":
              reports.append(("1h", "Intraday 1H"))
          if os.environ.get("SEND_4H") == "true":
              reports.append(("4h", "Intraday 4H"))
          if os.environ.get("SEND_1D") == "true":
              reports.append(("1d", "End of Day"))

          for tag, label in reports:
              text = render_email_text(
                  "out/signals/data/summary.json",
                  history_path="out/signals/data/score_history.json",
                  report_label=label,
                  display_timezone="Asia/Hong_Kong",
              )
              with open(f"email_body_{tag}.txt", "w") as f:
                  f.write(text)
              print(f"Rendered {tag} email ({len(text)} chars)")
          PYEOF
        env:
          SEND_1H: ${{ steps.market-check.outputs.send_1h }}
          SEND_4H: ${{ steps.market-check.outputs.send_4h }}
          SEND_1D: ${{ steps.market-check.outputs.send_1d }}

      # === SEND EMAILS ===

      - name: "Send email: 1H"
        if: steps.market-check.outputs.send_1h == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT || 587 }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "APEX Intraday 1H — ${{ steps.market-check.outputs.et_date }} ${{ steps.market-check.outputs.et_time }}"
          to: ${{ secrets.SIGNAL_REPORT_RECIPIENTS }}
          from: "APEX Signal Bot <${{ secrets.SMTP_USERNAME }}>"
          body: file://${{ github.workspace }}/email_body_1h.txt
          content_type: text/plain
          convert_markdown: false

      - name: "Send email: 4H"
        if: steps.market-check.outputs.send_4h == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT || 587 }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "APEX Intraday 4H — ${{ steps.market-check.outputs.et_date }} ${{ steps.market-check.outputs.et_time }}"
          to: ${{ secrets.SIGNAL_REPORT_RECIPIENTS }}
          from: "APEX Signal Bot <${{ secrets.SMTP_USERNAME }}>"
          body: file://${{ github.workspace }}/email_body_4h.txt
          content_type: text/plain
          convert_markdown: false

      - name: "Send email: 1D"
        if: steps.market-check.outputs.send_1d == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT || 587 }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "APEX End of Day — ${{ steps.market-check.outputs.et_date }} ${{ steps.market-check.outputs.et_time }}"
          to: ${{ secrets.SIGNAL_REPORT_RECIPIENTS }}
          from: "APEX Signal Bot <${{ secrets.SMTP_USERNAME }}>"
          body: file://${{ github.workspace }}/email_body_1d.txt
          content_type: text/plain
          convert_markdown: false

      - name: Holiday notice
        if: steps.market-check.outputs.should_run != 'true'
        run: echo "::notice::Market is closed today. Skipping report generation."

      - name: Upload report artifact
        if: steps.market-check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: signal-report-${{ github.run_id }}
          path: out/signals/
          if-no-files-found: warn
          retention-days: 7

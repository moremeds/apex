name: Nightly Verification

on:
  schedule:
    # Run at 2:00 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  # ═══════════════════════════════════════════════════════════════
  # Full Signal Verification with TA-Lib
  # ═══════════════════════════════════════════════════════════════

  signal-verification:
    name: Full Signal Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache TA-Lib
        id: cache-talib
        uses: actions/cache@v5
        with:
          path: /usr/lib/libta_lib*
          key: talib-0.4.0-ubuntu-latest

      - name: Install TA-Lib C library
        if: steps.cache-talib.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget build-essential
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib && ./configure --prefix=/usr && make && sudo make install
          sudo ldconfig

      - name: Install dependencies
        run: uv pip install --system -e ".[dev,observability]"

      - name: Run full signal verification (TA-Lib profile)
        run: |
          python -m src.verification.signal_verifier --all --profile signal_talib --json > signal_verification.json || true
          python -m src.verification.signal_verifier --all --profile signal_talib

      - name: Run signal nightly profile (performance checks)
        continue-on-error: true  # Performance checks are informational
        run: |
          python -m src.verification.signal_verifier --all --profile signal_nightly --json > signal_nightly.json || true

      - name: Upload signal verification results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: signal-verification-nightly
          path: |
            signal_verification.json
            signal_nightly.json
          if-no-files-found: ignore

  # ═══════════════════════════════════════════════════════════════
  # Full Regime Verification
  # ═══════════════════════════════════════════════════════════════

  regime-verification:
    name: Full Regime Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache TA-Lib
        id: cache-talib
        uses: actions/cache@v5
        with:
          path: /usr/lib/libta_lib*
          key: talib-0.4.0-ubuntu-latest

      - name: Install TA-Lib C library
        if: steps.cache-talib.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget build-essential
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib && ./configure --prefix=/usr && make && sudo make install
          sudo ldconfig

      - name: Install dependencies
        run: uv pip install --system -e ".[dev,observability]"

      - name: Run full regime verification (all checks)
        run: |
          python -m src.verification.regime_verifier --all --json > regime_verification.json || true
          python -m src.verification.regime_verifier --all

      - name: Upload regime verification results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: regime-verification-nightly
          path: regime_verification.json
          if-no-files-found: ignore

  # ═══════════════════════════════════════════════════════════════
  # Full Test Suite
  # ═══════════════════════════════════════════════════════════════

  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: [signal-verification, regime-verification]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache TA-Lib
        id: cache-talib
        uses: actions/cache@v5
        with:
          path: /usr/lib/libta_lib*
          key: talib-0.4.0-ubuntu-latest

      - name: Install TA-Lib C library
        if: steps.cache-talib.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y wget build-essential
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib && ./configure --prefix=/usr && make && sudo make install
          sudo ldconfig

      - name: Install dependencies
        run: uv pip install --system -e ".[dev,observability]"

      - name: Run full test suite with coverage
        continue-on-error: true  # Don't fail nightly on test failures
        run: |
          pytest tests/ -v --tb=short \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --ignore=tests/partial/

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-nightly
          path: |
            coverage.xml
            htmlcov/
          if-no-files-found: ignore

  # ═══════════════════════════════════════════════════════════════
  # Notification (on failure)
  # ═══════════════════════════════════════════════════════════════

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [signal-verification, regime-verification, full-test-suite]
    if: failure()
    steps:
      - name: Create failure summary
        run: |
          echo "## Nightly Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more nightly verification checks failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." >> $GITHUB_STEP_SUMMARY

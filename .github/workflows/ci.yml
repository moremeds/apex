name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 1: Parallel Quality Gates (no dependencies between them)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install linting tools
        run: uv pip install --system black isort flake8

      - name: Check formatting with black
        run: black --check src/ tests/

      - name: Check import sorting with isort
        run: isort --check-only src/ tests/

      - name: Run flake8
        run: flake8 src/ tests/

  dead-code:
    name: Dead Code Check
    runs-on: ubuntu-latest
    continue-on-error: true  # Informational - doesn't block CI
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install vulture
        run: uv pip install --system vulture

      - name: Check for dead code
        run: |
          echo "ğŸ” Checking for potentially unused code..."
          vulture src/ .vulture_whitelist.py \
            --min-confidence 80 \
            --exclude "src/legacy/,src/verification/" \
            --sort-by-size

  complexity:
    name: Complexity Check
    runs-on: ubuntu-latest
    continue-on-error: true  # Informational - doesn't block CI
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install radon
        run: uv pip install --system radon

      - name: Cyclomatic Complexity Report
        run: |
          echo "ğŸ“Š Cyclomatic Complexity Summary:"
          radon cc src/ -a -nc --total-average

      - name: Check for very complex functions (F grade)
        run: |
          echo "ğŸš¨ Checking for F-grade (very complex) functions..."
          # Fail if any function has F grade (cyclomatic complexity > 40)
          F_GRADE=$(radon cc src/ --min F -s 2>/dev/null || true)
          if [ -n "$F_GRADE" ]; then
            echo "âš ï¸ Found F-grade functions that should be refactored:"
            echo "$F_GRADE"
            exit 1
          else
            echo "âœ… No F-grade functions found"
          fi

      - name: Maintainability Index Report
        run: |
          echo "ğŸ”§ Maintainability Index (lowest-ranked files):"
          radon mi src/ -s | grep -E "^src.*[BC]$" | sort -t'-' -k2 | head -10 || echo "âœ… All files have good maintainability"

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    continue-on-error: false  # Enable strict enforcement once type errors are fixed
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]" types-PyYAML types-pytz

      - name: Run mypy
        run: |
          source .venv/bin/activate
          mypy src/ --ignore-missing-imports --disable-error-code=no-any-return

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install security tools
        run: uv pip install --system bandit safety

      - name: Run bandit security linter
        run: bandit -r src/ -ll -ii --exit-zero

      - name: Check dependencies for vulnerabilities
        continue-on-error: false  # Best-effort until safety is properly configured
        run: safety check --full-report || true

  verify:
    name: Signal & Regime Verification
    runs-on: ubuntu-latest
    # HARD GATE - verification failures block PR merge
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install project with observability deps
        run: uv pip install --system -e ".[observability]"

      - name: Run signal verification (4-layer contract checks)
        run: python -m src.verification.signal_verifier --all --profile signal_dev

      - name: Run regime verification
        run: python -m src.verification.regime_verifier --all --profile dev

      - name: Upload verification report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: verification-report
          path: |
            verification_*.json
            verification_*.html
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 2: Unit Tests (after quality gates pass)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [verify]  # type-check and security are best-effort
    continue-on-error: false  # Pre-existing test failures - fix incrementally
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache TA-Lib
        id: cache-talib
        uses: actions/cache@v5
        with:
          path: ~/ta-lib-install
          key: talib-0.6.4-${{ runner.os }}-${{ runner.arch }}

      - name: Install TA-Lib C library
        run: |
          if [ -d "$HOME/ta-lib-install/lib" ]; then
            echo "Restoring TA-Lib from cache..."
            sudo cp -r $HOME/ta-lib-install/lib/* /usr/lib/
            sudo cp -r $HOME/ta-lib-install/include/* /usr/include/
            sudo ldconfig
          else
            echo "Building TA-Lib 0.6.4 from source..."
            sudo apt-get update
            sudo apt-get install -y wget build-essential
            wget https://github.com/ta-lib/ta-lib/releases/download/v0.6.4/ta-lib-0.6.4-src.tar.gz
            tar -xzf ta-lib-0.6.4-src.tar.gz
            cd ta-lib-0.6.4 && ./configure --prefix=/usr && make -j$(nproc) && sudo make install
            sudo ldconfig
            mkdir -p $HOME/ta-lib-install/lib $HOME/ta-lib-install/include
            cp -r /usr/lib/libta* $HOME/ta-lib-install/lib/ 2>/dev/null || true
            cp -r /usr/include/ta-lib $HOME/ta-lib-install/include/ 2>/dev/null || true
          fi

      - name: Install dependencies
        run: uv pip install --system -e ".[dev,observability]"

      - name: Run unit tests with coverage
        run: |
          pytest tests/unit/ -v --tb=short \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=40

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage.xml
          if-no-files-found: ignore

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Phase 3: Integration Tests (after unit tests)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: success() || failure()  # Run even if unit-tests has continue-on-error failures
    continue-on-error: false
    timeout-minutes: 10  # Prevent runaway tests from blocking CI for hours
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache TA-Lib
        id: cache-talib
        uses: actions/cache@v5
        with:
          path: ~/ta-lib-install
          key: talib-0.6.4-${{ runner.os }}-${{ runner.arch }}

      - name: Install TA-Lib C library
        run: |
          if [ -d "$HOME/ta-lib-install/lib" ]; then
            echo "Restoring TA-Lib from cache..."
            sudo cp -r $HOME/ta-lib-install/lib/* /usr/lib/
            sudo cp -r $HOME/ta-lib-install/include/* /usr/include/
            sudo ldconfig
          else
            echo "Building TA-Lib 0.6.4 from source..."
            sudo apt-get update
            sudo apt-get install -y wget build-essential
            wget https://github.com/ta-lib/ta-lib/releases/download/v0.6.4/ta-lib-0.6.4-src.tar.gz
            tar -xzf ta-lib-0.6.4-src.tar.gz
            cd ta-lib-0.6.4 && ./configure --prefix=/usr && make -j$(nproc) && sudo make install
            sudo ldconfig
            mkdir -p $HOME/ta-lib-install/lib $HOME/ta-lib-install/include
            cp -r /usr/lib/libta* $HOME/ta-lib-install/lib/ 2>/dev/null || true
            cp -r /usr/include/ta-lib $HOME/ta-lib-install/include/ 2>/dev/null || true
          fi

      - name: Install dependencies
        run: uv pip install --system -e ".[dev,observability]"

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --tb=short --no-cov \
            --ignore=tests/partial/ \
            --ignore=tests/integration/test_futu_adapter.py \
            --ignore=tests/integration/test_multi_broker.py

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Coverage Upload (PRs only, best-effort)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  coverage-upload:
    name: Upload Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event_name == 'pull_request'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - name: Download coverage artifact
        uses: actions/download-artifact@v7
        with:
          name: coverage-report
        continue-on-error: false

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

name: CI
on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  # ═══════════════════════════════════════════════════════════════
  # Job 1: Lint (Python 3.13 - stable for linting tools)
  # ═══════════════════════════════════════════════════════════════
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"
          cache-suffix: "lint"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install linting tools
        run: uv pip install black isort flake8 mypy types-PyYAML types-jsonschema --system

      - name: Run black
        run: black --check src/ tests/

      - name: Run isort
        run: isort --check-only src/ tests/

      - name: Run flake8
        run: |
          # Ignore pre-existing issues - to be fixed in cleanup PR
          flake8 src/ tests/ --max-line-length=100 \
            --ignore=E501,W503,F401,F841,F821,E226,E203,E402,E704,F541,F811,E741,E731,F824,F402,E712

      - name: Run mypy
        run: mypy src/ --ignore-missing-imports --no-error-summary || true
        # Note: mypy strict mode may need gradual adoption

  # ═══════════════════════════════════════════════════════════════
  # Job 2: Contract & Invariants (Python 3.13 - NO TA-Lib)
  # ═══════════════════════════════════════════════════════════════
  contract:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"
          cache-suffix: "contract-py313"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies (without TA-Lib)
        run: |
          uv pip install -e ".[dev,observability]" --system
          # Ensure TA-Lib is not required for contract tests
          pip uninstall -y TA-Lib 2>/dev/null || true

      - name: Run signal contract verification
        run: python -m src.verification.signal_verifier --all --profile signal_dev

      - name: Run regime contract verification
        run: python -m src.verification.regime_verifier --all --profile dev

      - name: Run ALL unit tests
        run: |
          pytest tests/unit/ -v \
            --ignore=tests/unit/signals/test_talib_alignment.py \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # ═══════════════════════════════════════════════════════════════
  # Job 3: TA-Lib Alignment (Python 3.13 - WITH TA-Lib)
  # ═══════════════════════════════════════════════════════════════
  talib-alignment:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"
          cache-suffix: "talib-py313"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Python dependencies
        run: uv pip install -e ".[dev,observability]" --system

      - name: Try TA-Lib wheels first (fast)
        id: talib-wheels
        continue-on-error: true
        run: |
          pip install TA-Lib && echo "TALIB_INSTALLED=wheels" >> $GITHUB_OUTPUT

      - name: Fallback - Install TA-Lib C library from source
        id: talib-compile
        if: steps.talib-wheels.outcome != 'success'
        continue-on-error: true
        run: |
          echo "::notice::Wheels unavailable, compiling TA-Lib from source..."
          sudo apt-get update && sudo apt-get install -y wget build-essential
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz && cd ta-lib
          ./configure --prefix=/usr && make && sudo make install
          sudo ldconfig
          pip install TA-Lib && echo "TALIB_INSTALLED=compiled" >> $GITHUB_OUTPUT

      - name: Run TA-Lib alignment verification
        if: steps.talib-wheels.outcome == 'success' || steps.talib-compile.outcome == 'success'
        run: |
          python -m src.verification.signal_verifier --all --profile signal_talib || true

      - name: Run TA-Lib alignment tests
        if: steps.talib-wheels.outcome == 'success' || steps.talib-compile.outcome == 'success'
        run: |
          pytest tests/unit/signals/test_talib_alignment.py -v || true
        continue-on-error: true

      - name: Skip TA-Lib alignment (fallback)
        if: steps.talib-wheels.outcome != 'success' && steps.talib-compile.outcome != 'success'
        run: |
          echo "::warning::TA-Lib not available - skipping alignment tests"
          echo "This is expected on some runners. Alignment tests will run where TA-Lib is available."

  # ═══════════════════════════════════════════════════════════════
  # Job 4: Integration Tests (Python 3.13)
  # ═══════════════════════════════════════════════════════════════
  integration:
    runs-on: ubuntu-latest
    needs: [contract]
    if: github.event_name == 'push' || github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"
          cache-suffix: "integration"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv pip install -e ".[dev,observability]" --system

      - name: Run integration tests
        run: pytest tests/integration/ -v --tb=short

  # ═══════════════════════════════════════════════════════════════
  # Final: Status Gate (only required jobs)
  # ═══════════════════════════════════════════════════════════════
  ci-success:
    runs-on: ubuntu-latest
    needs: [lint, contract, talib-alignment, integration]
    if: always()
    steps:
      - name: Check required jobs
        run: |
          echo "Lint result: ${{ needs.lint.result }}"
          echo "Contract result: ${{ needs.contract.result }}"
          echo "TA-Lib alignment result: ${{ needs.talib-alignment.result }}"
          echo "Integration result: ${{ needs.integration.result }}"

          # Lint must pass
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "::error::Lint job failed"
            exit 1
          fi

          # Contract (includes ALL unit tests) must pass
          if [[ "${{ needs.contract.result }}" != "success" ]]; then
            echo "::error::Contract verification or unit tests failed"
            exit 1
          fi

          # Integration tests must pass (may be skipped for draft PRs)
          if [[ "${{ needs.integration.result }}" == "failure" ]]; then
            echo "::error::Integration tests failed"
            exit 1
          fi

          # talib-alignment is best-effort (may skip if TA-Lib unavailable)
          if [[ "${{ needs.talib-alignment.result }}" == "failure" ]]; then
            echo "::warning::TA-Lib alignment failed - review required"
            # Don't fail CI, just warn
          fi

          echo "::notice::All required CI checks passed!"
          echo "CI_STATUS=success" >> $GITHUB_ENV

      - name: Summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Contract + Unit Tests | ${{ needs.contract.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TA-Lib Alignment | ${{ needs.talib-alignment.result }} |" >> $GITHUB_STEP_SUMMARY
